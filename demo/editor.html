<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¶³è¿¹æ•°æ®æ„å»ºå™¨ - XiaoTen FootprintMap</title>
  <link rel="stylesheet" href="../static/css/footprintmap.css" />
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; background:#f5f7fa; margin:0; }
    header { padding:20px 24px; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; }
    header h1 { margin:0 0 6px; font-size:22px; }
    header p { margin:0; opacity:.85; font-size:14px; }
    main { display:flex; flex-wrap:wrap; gap:20px; padding:20px 24px; }
    .panel { background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:18px 20px; flex:1 1 420px; box-shadow:0 2px 6px rgba(0,0,0,.04); min-width:320px; }
    .panel h2 { margin:0 0 14px; font-size:16px; color:#334155; display:flex; align-items:center; gap:6px; }
    form .group { margin-bottom:12px; }
    label { display:block; font-size:12px; font-weight:600; color:#475569; margin-bottom:4px; }
    input[type=text], input[type=date], textarea, select { width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; font-size:14px; background:#fff; }
    textarea { resize:vertical; min-height:70px; }
    .inline { display:flex; gap:10px; }
    .inline .group { flex:1; }
    button, .btn { cursor:pointer; border:1px solid #6366f1; background:#6366f1; color:#fff; padding:8px 14px; font-size:14px; border-radius:6px; transition:.15s; }
    button.secondary, .btn.secondary { background:#fff; color:#374151; border-color:#cbd5e1; }
    button.danger { background:#dc2626; border-color:#dc2626; }
    button:hover, .btn:hover { filter:brightness(1.08); }
    #map { height:360px; border-radius:8px; overflow:hidden; border:1px solid #cbd5e1; }
    .photos-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .photos-list .photo-item { background:#f1f5f9; padding:4px 6px; border-radius:4px; font-size:11px; display:flex; align-items:center; gap:4px; }
    .photos-list .photo-item button { background:none; color:#dc2626; border:none; padding:0 4px; font-size:12px; }
    .location-list { max-height:300px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:8px; background:#fff; }
    .location-item { border:1px solid #e2e8f0; border-radius:8px; padding:8px 10px; margin-bottom:8px; background:#f8fafc; font-size:13px; position:relative; }
    .location-item h3 { margin:0 0 4px; font-size:14px; color:#334155; }
    .tag { display:inline-block; background:#6366f1; color:#fff; padding:2px 6px; font-size:11px; border-radius:4px; margin-right:4px; margin-top:4px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    pre#jsonOutput { background:#0f172a; color:#e2e8f0; padding:14px; border-radius:8px; font-size:13px; overflow:auto; max-height:320px; }
    footer { text-align:center; padding:30px 20px; font-size:12px; color:#64748b; }
    .split { display:flex; flex-direction:column; gap:12px; }
    .import-block { border:1px dashed #94a3b8; padding:10px; border-radius:8px; background:#f8fafc; }
    .small { font-size:11px; color:#64748b; }
    @media (max-width:900px){ main{ flex-direction:column;} }
  </style>
</head>
<body>
  <header>
    <h1>è¶³è¿¹æ•°æ®æ„å»ºå™¨</h1>
    <p>å¯è§†åŒ–å½•å…¥åœ°ç‚¹ä¿¡æ¯ï¼Œç”Ÿæˆç¬¦åˆ FootprintMap è§„èŒƒçš„ JSON æ•°æ®ã€‚</p>
  </header>
  <main>
    <section class="panel" style="flex:1 1 480px;">
      <h2>ğŸ“ åœ°ç‚¹å½•å…¥</h2>
      <form id="locationForm" autocomplete="off">
        <div id="formErrors" style="display:none; margin-bottom:12px; padding:8px 10px; border:1px solid #dc2626; background:#fef2f2; color:#b91c1c; border-radius:6px; font-size:12px;"></div>
        <div class="group">
          <label>åç§° *</label>
          <input type="text" id="name" required placeholder="å¦‚ï¼šåŒ—äº¬" />
        </div>
        <div class="group">
          <label>æè¿° *</label>
          <textarea id="description" required placeholder="ç®€è¦æè¿°è¯¥åœ°ç‚¹"></textarea>
        </div>
        <div class="inline">
          <div class="group">
            <label>æ—¥æœŸ *</label>
            <input type="date" id="date" required />
          </div>
          <div class="group">
            <label>åæ ‡ (ç‚¹å‡»åœ°å›¾è‡ªåŠ¨å¡«å…¥) *</label>
            <input type="text" id="coordinates" required placeholder="lng,lat" />
          </div>
        </div>
        <div class="inline">
          <div class="group">
            <label>åˆ†ç±»ï¼ˆè‹±æ–‡é€—å·åˆ†éš”ï¼‰</label>
            <input type="text" id="categories" placeholder="2024,æ—…è¡Œ,åŸå¸‚" />
          </div>
          <div class="group">
            <label>æ ‡è®°é¢œè‰² *</label>
            <select id="markerColor" required>
              <option value="sunset">sunset</option>
              <option value="ocean">ocean</option>
              <option value="forest">forest</option>
              <option value="amber">amber</option>
              <option value="violet">violet</option>
              <option value="citrus">citrus</option>
            </select>
          </div>
        </div>
        <div class="group">
          <label>å›¾ç‰‡ URLï¼ˆè¾“å…¥åå›è½¦æˆ–ç‚¹å‡»æ·»åŠ ï¼‰</label>
          <input type="text" id="photoInput" placeholder="https://...jpg" />
          <div class="photos-list" id="photosList"></div>
        </div>
        <div class="inline">
          <div class="group">
            <label>å…³è”é“¾æ¥ URL</label>
            <input type="text" id="url" placeholder="https://ä½ çš„åšå®¢æ–‡ç« " />
          </div>
          <div class="group">
            <label>é“¾æ¥æ–‡å­—</label>
            <input type="text" id="urlLabel" placeholder="é˜…è¯»æ¸¸è®°" />
          </div>
        </div>
        <div class="controls">
          <button type="submit">â• æ·»åŠ åœ°ç‚¹</button>
          <button type="button" class="secondary" id="resetFormBtn">æ¸…ç©ºè¡¨å•</button>
        </div>
        <p class="small">å¿…å¡«é¡¹ï¼šåç§° / æè¿° / æ—¥æœŸ / åæ ‡ / æ ‡è®°é¢œè‰²ã€‚</p>
      </form>
      <h2 style="margin-top:26px;">ğŸ—ºï¸ åæ ‡æ‹¾å–</h2>
      <div id="map"></div>
      <p class="small">ç‚¹å‡»åœ°å›¾å³å¯å†™å…¥ç»çº¬åº¦ï¼ˆæ ¼å¼ï¼šlng,latï¼‰ã€‚</p>
    </section>

    <section class="panel" style="flex:1 1 420px;">
      <h2>ğŸ“ å·²æ·»åŠ åœ°ç‚¹</h2>
      <div class="location-list" id="locationList"></div>
      <div class="controls">
        <button type="button" class="secondary" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰</button>
        <button type="button" class="danger" id="removeLastBtn">åˆ é™¤æœ€åä¸€ä¸ª</button>
      </div>
      <div class="import-block" style="margin-top:14px;">
        <label style="font-weight:600; font-size:12px;">å¯¼å…¥å·²æœ‰ JSON æ–‡ä»¶</label>
        <input type="file" id="importFile" accept="application/json" />
        <p class="small">ä¼šå°è¯•è¯»å–å…¶ä¸­çš„ locations å¹¶è¿½åŠ ã€‚</p>
      </div>
      <h2 style="margin-top:24px;">ğŸ§¾ å¯¼å‡º JSON</h2>
      <div class="controls">
        <button type="button" id="generateBtn">ç”Ÿæˆ JSON</button>
        <button type="button" class="secondary" id="copyBtn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        <button type="button" class="secondary" id="downloadBtn">ä¸‹è½½æ–‡ä»¶</button>
        <button type="button" class="secondary" id="toggleAutoPreviewBtn" data-on="1">å…³é—­å®æ—¶é¢„è§ˆ</button>
      </div>
      <pre id="jsonOutput" aria-label="è¾“å‡º JSON"></pre>
      <h2 style="margin-top:24px;">ğŸ” å®æ—¶é¢„è§ˆ</h2>
      <div id="previewMap" style="width:100%;height:300px;border:1px solid #cbd5e1; border-radius:8px; background:#f1f5f9; position:relative; overflow:hidden;"></div>
      <p class="small">é¢„è§ˆä½¿ç”¨ç®€åŒ–ç‰ˆæ¸²æŸ“ï¼ˆæ ‡è®°ã€èšç„¦ï¼‰ï¼Œæœ€ç»ˆæ•ˆæœä»¥æ­£å¼ FootprintMap ä¸ºå‡†ã€‚</p>
    </section>
  </main>
  <footer>
    <div>Made with â¤ï¸ XiaoTen-FootprintMap æ•°æ®æ„å»ºå™¨ Â· æœ¬åœ°ä¿å­˜è‰ç¨¿ï¼Œä¸ä¼šä¸Šä¼ ã€‚</div>
  </footer>

  <script src="https://webapi.amap.com/maps?v=2.0&key=4727334ebc13608dbe9ba75266c3d41a"></script>
  <script>
    const form = document.getElementById('locationForm');
    const photosListEl = document.getElementById('photosList');
    const photoInput = document.getElementById('photoInput');
    const locationListEl = document.getElementById('locationList');
    const jsonOutput = document.getElementById('jsonOutput');
    const formErrorsEl = document.getElementById('formErrors');
    const previewMapEl = document.getElementById('previewMap');
    const toggleAutoPreviewBtn = document.getElementById('toggleAutoPreviewBtn');
    let photosTemp = [];
    let locations = [];
    let editingIndex = null; // è‹¥ä¸ä¸º null åˆ™è¡¨ç¤ºå½“å‰ä¸ºç¼–è¾‘æ¨¡å¼
    let autoPreview = true;
    let previewMapInstance = null;
    const markerGradients = {
      sunset: 'linear-gradient(135deg, #ffb347, #ff6f61)',
      ocean: 'linear-gradient(135deg, #06beb6, #48b1bf)',
      forest: 'linear-gradient(135deg, #5ee7df, #39a37c)',
      amber: 'linear-gradient(135deg, #f6d365, #fda085)',
      violet: 'linear-gradient(135deg, #a18cd1, #fbc2eb)',
      citrus: 'linear-gradient(135deg, #fdfb8f, #a1ffce)'
    };

    // æ¢å¤è‰ç¨¿
    try { const draft = localStorage.getItem('footprintmap_builder_locations'); if (draft) locations = JSON.parse(draft); } catch(e){}

    function persistDraft(){ localStorage.setItem('footprintmap_builder_locations', JSON.stringify(locations)); }

    function renderPhotosTemp(){
      photosListEl.innerHTML = '';
      photosTemp.forEach((url,idx)=>{
        const div = document.createElement('div');
        div.className='photo-item';
        div.innerHTML = `<span>${url.replace(/^https?:\/\//,'').slice(0,40)}</span>`;
        const btn = document.createElement('button');
        btn.type='button'; btn.textContent='Ã—';
        btn.onclick=()=>{ photosTemp.splice(idx,1); renderPhotosTemp(); };
        div.appendChild(btn); photosListEl.appendChild(div);
      });
    }

    photoInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); addPhotoUrl(); }
    });
    function addPhotoUrl(){
      const v = photoInput.value.trim(); if(!v) return; photosTemp.push(v); photoInput.value=''; renderPhotosTemp();
    }

    // æ ¡éªŒå‡½æ•°
    function validateCoordinates(str){
      const re = /^\s*(-?\d+(?:\.\d+)?)[,ï¼Œ]\s*(-?\d+(?:\.\d+)?)\s*$/;
      const m = re.exec(str);
      if(!m) return null;
      const lng = parseFloat(m[1]); const lat = parseFloat(m[2]);
      if(Math.abs(lng)>180 || Math.abs(lat)>90) return null;
      return { lng, lat };
    }
    function isValidUrl(str){
      if(!str) return true; // ç©ºå…è®¸
      try { const u = new URL(str); return ['http:','https:'].includes(u.protocol); } catch(e){ return false; }
    }
    function collectErrors(fields){
      const errs = [];
      if(!fields.name) errs.push('åç§°ä¸èƒ½ä¸ºç©º');
      if(!fields.description) errs.push('æè¿°ä¸èƒ½ä¸ºç©º');
      if(!fields.date) errs.push('æ—¥æœŸä¸èƒ½ä¸ºç©º');
      if(!fields.coordinates) errs.push('åæ ‡ä¸èƒ½ä¸ºç©º');
      if(!fields.markerColor) errs.push('æ ‡è®°é¢œè‰²ä¸èƒ½ä¸ºç©º');
      if(fields.coordinates && !validateCoordinates(fields.coordinates)) errs.push('åæ ‡æ ¼å¼é”™è¯¯æˆ–èŒƒå›´éæ³• (lng,lat)');
      if(fields.url && !isValidUrl(fields.url)) errs.push('å…³è”é“¾æ¥ URL éæ³•');
      for(const p of fields.photos){ if(!isValidUrl(p)) { errs.push('å›¾ç‰‡ URL éæ³•: '+p); break; } }
      const duplicateIndex = locations.findIndex((l,i)=> l.name === fields.name && i!==editingIndex);
      if(duplicateIndex !== -1) errs.push('åç§°å·²å­˜åœ¨ï¼š"'+fields.name+'"');
      return errs;
    }
    function showErrors(errs){
      if(!errs.length){ formErrorsEl.style.display='none'; formErrorsEl.textContent=''; return; }
      formErrorsEl.style.display='block'; formErrorsEl.innerHTML = errs.map(e=>`<div>â€¢ ${e}</div>`).join('');
    }

    // æ‹–æ‹½æ’åº
    function enableDragForItems(){
      locationListEl.querySelectorAll('.location-item').forEach(item=>{
        item.draggable = true;
        item.addEventListener('dragstart', e=>{
          e.dataTransfer.setData('text/plain', item.dataset.idx);
          item.classList.add('dragging');
        });
        item.addEventListener('dragend', ()=> item.classList.remove('dragging'));
        item.addEventListener('dragover', e=> e.preventDefault());
        item.addEventListener('drop', e=>{
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData('text/plain'),10);
          const to = parseInt(item.dataset.idx,10);
          if(isNaN(from)||isNaN(to)||from===to) return;
          const moved = locations.splice(from,1)[0];
          locations.splice(to,0,moved);
          renderLocations(); persistDraft(); triggerAutoPreview();
        });
      });
    }

    // æ·»åŠ åœ°ç‚¹
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const date = document.getElementById('date').value.trim();
      const coordinates = document.getElementById('coordinates').value.trim();
      const markerColor = document.getElementById('markerColor').value.trim();
      const categoriesRaw = document.getElementById('categories').value.trim();
      const url = document.getElementById('url').value.trim();
      const urlLabel = document.getElementById('urlLabel').value.trim();
      const categories = categoriesRaw ? categoriesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      const draftObj = { name, coordinates, description, date, url, urlLabel, photos:[...photosTemp], categories, markerColor };
      const errs = collectErrors(draftObj);
      showErrors(errs);
      if(errs.length){ return; }
      if(editingIndex !== null){
        locations[editingIndex] = draftObj;
        editingIndex = null;
      } else {
        locations.push(draftObj);
      }
      photosTemp=[]; renderPhotosTemp(); form.reset(); renderLocations(); persistDraft(); triggerAutoPreview(); jsonOutput.textContent='';
    });

    document.getElementById('resetFormBtn').onclick=()=>{ form.reset(); photosTemp=[]; renderPhotosTemp(); };
    document.getElementById('clearAllBtn').onclick=()=>{ if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åœ°ç‚¹?')){ locations=[]; renderLocations(); persistDraft(); triggerAutoPreview(); jsonOutput.textContent=''; } };
    document.getElementById('removeLastBtn').onclick=()=>{ locations.pop(); renderLocations(); persistDraft(); triggerAutoPreview(); };

    function renderLocations(){
      locationListEl.innerHTML='';
      locations.forEach((loc,idx)=>{
        const item = document.createElement('div'); item.className='location-item';
        item.dataset.idx = idx;
        const h = document.createElement('h3'); h.textContent = `${idx+1}. ${loc.name}`; item.appendChild(h);
        const meta = document.createElement('div'); meta.textContent = `${loc.date} Â· ${loc.coordinates}`; meta.style.fontSize='11px'; meta.style.color='#64748b'; item.appendChild(meta);
        const desc = document.createElement('div'); desc.textContent = loc.description.slice(0,120); desc.style.margin='6px 0'; item.appendChild(desc);
        if(loc.categories && loc.categories.length){ const cWrap=document.createElement('div'); loc.categories.forEach(c=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=c; cWrap.appendChild(span); }); item.appendChild(cWrap); }
        if(loc.photos && loc.photos.length){ const p=document.createElement('div'); p.style.fontSize='11px'; p.style.marginTop='4px'; p.textContent = `ğŸ“¸ ${loc.photos.length} å¼ å›¾ç‰‡`; item.appendChild(p); }
        if(loc.url){ const u=document.createElement('a'); u.href=loc.url; u.target='_blank'; u.textContent= loc.urlLabel || 'é“¾æ¥'; u.style.display='inline-block'; u.style.fontSize='11px'; u.style.marginTop='4px'; item.appendChild(u); }
        const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.textContent='åˆ é™¤'; delBtn.className='danger'; delBtn.style.position='absolute'; delBtn.style.top='8px'; delBtn.style.right='8px';
        delBtn.onclick=()=>{ locations.splice(idx,1); renderLocations(); persistDraft(); };
        const editBtn = document.createElement('button'); editBtn.type='button'; editBtn.textContent='ç¼–è¾‘'; editBtn.className='secondary'; editBtn.style.position='absolute'; editBtn.style.top='8px'; editBtn.style.right='70px';
        editBtn.onclick=()=>{
          editingIndex = idx;
          document.getElementById('name').value = loc.name;
          document.getElementById('description').value = loc.description;
          document.getElementById('date').value = loc.date && /\d{4}-\d{2}-\d{2}/.test(loc.date) ? loc.date : '';
          document.getElementById('coordinates').value = loc.coordinates;
          document.getElementById('categories').value = (loc.categories||[]).join(',');
          document.getElementById('markerColor').value = loc.markerColor || 'sunset';
          document.getElementById('url').value = loc.url || '';
          document.getElementById('urlLabel').value = loc.urlLabel || '';
          photosTemp = [...(loc.photos||[])]; renderPhotosTemp();
          showErrors([]);
          window.scrollTo({ top:0, behavior:'smooth' });
        };
        item.appendChild(editBtn);
        item.appendChild(delBtn); locationListEl.appendChild(item);
      });
      enableDragForItems();
    }

    // ç”Ÿæˆ JSON
    function generateJson(){
      const obj = { locations };
      const text = JSON.stringify(obj, null, 2);
      jsonOutput.textContent = text;
    }
    document.getElementById('generateBtn').onclick=()=>{ generateJson(); renderPreviewMap(); };
    document.getElementById('copyBtn').onclick=()=>{
      if(!jsonOutput.textContent){ alert('è¯·å…ˆç”Ÿæˆ JSON'); return; }
      navigator.clipboard.writeText(jsonOutput.textContent).then(()=> alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')); };
    document.getElementById('downloadBtn').onclick=()=>{
      if(!jsonOutput.textContent){ alert('è¯·å…ˆç”Ÿæˆ JSON'); return; }
      const blob = new Blob([jsonOutput.textContent], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'footprints.generated.json'; a.click(); URL.revokeObjectURL(a.href); };
    toggleAutoPreviewBtn.onclick=()=>{
      autoPreview = !autoPreview;
      toggleAutoPreviewBtn.textContent = autoPreview ? 'å…³é—­å®æ—¶é¢„è§ˆ' : 'å¼€å¯å®æ—¶é¢„è§ˆ';
      toggleAutoPreviewBtn.dataset.on = autoPreview ? '1':'0';
      if(autoPreview){ triggerAutoPreview(); } else { /* ä¿ç•™å½“å‰ */ }
    };

    // å¯¼å…¥æ–‡ä»¶
    document.getElementById('importFile').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader(); reader.onload=()=>{
        try { const data = JSON.parse(reader.result); if(Array.isArray(data.locations)){ data.locations.forEach(l=>{ if(l.name && l.coordinates){ locations.push(l); } }); renderLocations(); persistDraft(); alert('å¯¼å…¥å¹¶è¿½åŠ å®Œæˆ'); } else { alert('JSON ä¸­ä¸å« locations æ•°ç»„'); } } catch(err){ alert('è§£æå¤±è´¥: '+ err.message); }
      }; reader.readAsText(file);
    });

    // åˆå§‹æ¸²æŸ“
    renderLocations(); renderPhotosTemp();

    // åœ°å›¾åˆå§‹åŒ–ä¸ç‚¹å‡»æ‹¾å–
    const map = new AMap.Map('map',{ viewMode:'2D', zoom:4, center:[105,36] });
    map.on('click', function(ev){ if(ev && ev.lnglat){ const { lng, lat } = ev.lnglat; document.getElementById('coordinates').value = lng.toFixed(6)+','+lat.toFixed(6); } });

    // é¢„è§ˆåœ°å›¾æ¸²æŸ“
    function renderPreviewMap(){
      if(!previewMapEl) return;
      if(!locations.length){ previewMapEl.innerHTML='<div style="padding:12px;font-size:12px;color:#64748b;">æš‚æ— åœ°ç‚¹ï¼Œæ·»åŠ åæ˜¾ç¤ºé¢„è§ˆã€‚</div>'; return; }
      try {
        if(!previewMapInstance){
          previewMapInstance = new AMap.Map(previewMapEl,{ viewMode:'2D', zoom:4, center:[105,36] });
        }
        // æ¸…ç†æ—§è¦†ç›–ç‰©
        const old = previewMapInstance.getAllOverlays('marker') || [];
        old.forEach(m=> previewMapInstance.remove(m));
        let bounds = [];
        locations.forEach((loc,i)=>{
          const coord = validateCoordinates(loc.coordinates);
          if(!coord) return;
          const gradient = markerGradients[loc.markerColor] || markerGradients.sunset;
          const marker = new AMap.Marker({
            position:[coord.lng, coord.lat],
            content:`<span style=\"display:inline-block;width:20px;height:20px;border-radius:50%;background:${gradient};border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.25);cursor:pointer\" title=\"${loc.name}\"></span>`,
            offset:new AMap.Pixel(-10,-10)
          });
            marker.on('click',()=>{
              const info = new AMap.InfoWindow({ anchor:'bottom-center', content:`<div style='font-size:12px;max-width:220px;'><strong>${loc.name}</strong><br>${loc.date||''}<br>${(loc.description||'').slice(0,80)}${loc.description&&loc.description.length>80?'...':''}</div>` });
              info.open(previewMapInstance,[coord.lng, coord.lat]);
            });
          previewMapInstance.add(marker);
          bounds.push([coord.lng, coord.lat]);
        });
        if(bounds.length){ previewMapInstance.setFitView(); }
      } catch(err){
        previewMapEl.innerHTML = '<div style="padding:12px;color:#dc2626;font-size:12px;">é¢„è§ˆæ¸²æŸ“å¤±è´¥: '+ err.message +'</div>';
      }
    }
    function triggerAutoPreview(){ if(autoPreview){ generateJson(); renderPreviewMap(); } }
    // åˆå§‹å°è¯•é¢„è§ˆ
    triggerAutoPreview();
  </script>
</body>
</html>