<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¶³è¿¹æ•°æ®æ„å»ºå™¨ - XiaoTen FootprintMap</title>
  <link rel="stylesheet" href="../static/css/footprintmap.css" />
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; background:#f5f7fa; margin:0; }
    header { padding:20px 24px; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; }
    header h1 { margin:0 0 6px; font-size:22px; }
    header p { margin:0; opacity:.85; font-size:14px; }
    main { display:flex; flex-wrap:wrap; gap:20px; padding:20px 24px; }
    .panel { background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:18px 20px; flex:1 1 420px; box-shadow:0 2px 6px rgba(0,0,0,.04); min-width:320px; }
    .panel h2 { margin:0 0 14px; font-size:16px; color:#334155; display:flex; align-items:center; gap:6px; }
    form .group { margin-bottom:12px; }
    label { display:block; font-size:12px; font-weight:600; color:#475569; margin-bottom:4px; }
    input[type=text], input[type=date], textarea, select { width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:6px; font-size:14px; background:#fff; }
    textarea { resize:vertical; min-height:70px; }
    .inline { display:flex; gap:10px; }
    .inline .group { flex:1; }
    button, .btn { cursor:pointer; border:1px solid #6366f1; background:#6366f1; color:#fff; padding:8px 14px; font-size:14px; border-radius:6px; transition:.15s; }
    button.secondary, .btn.secondary { background:#fff; color:#374151; border-color:#cbd5e1; }
    button.danger { background:#dc2626; border-color:#dc2626; }
    button:hover, .btn:hover { filter:brightness(1.08); }
    #map { height:360px; border-radius:8px; overflow:hidden; border:1px solid #cbd5e1; }
    .photos-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .photos-list .photo-item { background:#f1f5f9; padding:4px 6px; border-radius:4px; font-size:11px; display:flex; align-items:center; gap:4px; }
    .photos-list .photo-item button { background:none; color:#dc2626; border:none; padding:0 4px; font-size:12px; }
    .location-list { max-height:300px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:8px; background:#fff; }
    .location-item { border:1px solid #e2e8f0; border-radius:8px; padding:8px 10px; margin-bottom:8px; background:#f8fafc; font-size:13px; position:relative; }
    .location-item h3 { margin:0 0 4px; font-size:14px; color:#334155; }
    .tag { display:inline-block; background:#6366f1; color:#fff; padding:2px 6px; font-size:11px; border-radius:4px; margin-right:4px; margin-top:4px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    pre#jsonOutput { background:#0f172a; color:#e2e8f0; padding:14px; border-radius:8px; font-size:13px; overflow:auto; max-height:320px; }
    footer { text-align:center; padding:30px 20px; font-size:12px; color:#64748b; }
    .split { display:flex; flex-direction:column; gap:12px; }
    .import-block { border:1px dashed #94a3b8; padding:10px; border-radius:8px; background:#f8fafc; }
    .small { font-size:11px; color:#64748b; }
    @media (max-width:900px){ main{ flex-direction:column;} }
  </style>
</head>
<body>
  <header>
    <h1>è¶³è¿¹æ•°æ®æ„å»ºå™¨</h1>
    <p>å¯è§†åŒ–å½•å…¥åœ°ç‚¹ä¿¡æ¯ï¼Œç”Ÿæˆç¬¦åˆ FootprintMap è§„èŒƒçš„ JSON æ•°æ®ã€‚</p>
  </header>
  <main>
    <section class="panel" style="flex:1 1 480px;">
      <h2>ğŸ“ åœ°ç‚¹å½•å…¥</h2>
      <form id="locationForm" autocomplete="off">
        <div class="group">
          <label>åç§° *</label>
          <input type="text" id="name" required placeholder="å¦‚ï¼šåŒ—äº¬" />
        </div>
        <div class="group">
          <label>æè¿° *</label>
          <textarea id="description" required placeholder="ç®€è¦æè¿°è¯¥åœ°ç‚¹"></textarea>
        </div>
        <div class="inline">
          <div class="group">
            <label>æ—¥æœŸ *</label>
            <input type="date" id="date" required />
          </div>
          <div class="group">
            <label>åæ ‡ (ç‚¹å‡»åœ°å›¾è‡ªåŠ¨å¡«å…¥) *</label>
            <input type="text" id="coordinates" required placeholder="lng,lat" />
          </div>
        </div>
        <div class="inline">
          <div class="group">
            <label>åˆ†ç±»ï¼ˆè‹±æ–‡é€—å·åˆ†éš”ï¼‰</label>
            <input type="text" id="categories" placeholder="2024,æ—…è¡Œ,åŸå¸‚" />
          </div>
          <div class="group">
            <label>æ ‡è®°é¢œè‰² *</label>
            <select id="markerColor" required>
              <option value="sunset">sunset</option>
              <option value="ocean">ocean</option>
              <option value="forest">forest</option>
              <option value="amber">amber</option>
              <option value="violet">violet</option>
              <option value="citrus">citrus</option>
            </select>
          </div>
        </div>
        <div class="group">
          <label>å›¾ç‰‡ URLï¼ˆè¾“å…¥åå›è½¦æˆ–ç‚¹å‡»æ·»åŠ ï¼‰</label>
          <input type="text" id="photoInput" placeholder="https://...jpg" />
          <div class="photos-list" id="photosList"></div>
        </div>
        <div class="inline">
          <div class="group">
            <label>å…³è”é“¾æ¥ URL</label>
            <input type="text" id="url" placeholder="https://ä½ çš„åšå®¢æ–‡ç« " />
          </div>
          <div class="group">
            <label>é“¾æ¥æ–‡å­—</label>
            <input type="text" id="urlLabel" placeholder="é˜…è¯»æ¸¸è®°" />
          </div>
        </div>
        <div class="controls">
          <button type="submit">â• æ·»åŠ åœ°ç‚¹</button>
          <button type="button" class="secondary" id="resetFormBtn">æ¸…ç©ºè¡¨å•</button>
        </div>
        <p class="small">å¿…å¡«é¡¹ï¼šåç§° / æè¿° / æ—¥æœŸ / åæ ‡ / æ ‡è®°é¢œè‰²ã€‚</p>
      </form>
      <h2 style="margin-top:26px;">ğŸ—ºï¸ åæ ‡æ‹¾å–</h2>
      <div id="map"></div>
      <p class="small">ç‚¹å‡»åœ°å›¾å³å¯å†™å…¥ç»çº¬åº¦ï¼ˆæ ¼å¼ï¼šlng,latï¼‰ã€‚</p>
    </section>

    <section class="panel" style="flex:1 1 420px;">
      <h2>ğŸ“ å·²æ·»åŠ åœ°ç‚¹</h2>
      <div class="location-list" id="locationList"></div>
      <div class="controls">
        <button type="button" class="secondary" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰</button>
        <button type="button" class="danger" id="removeLastBtn">åˆ é™¤æœ€åä¸€ä¸ª</button>
      </div>
      <div class="import-block" style="margin-top:14px;">
        <label style="font-weight:600; font-size:12px;">å¯¼å…¥å·²æœ‰ JSON æ–‡ä»¶</label>
        <input type="file" id="importFile" accept="application/json" />
        <p class="small">ä¼šå°è¯•è¯»å–å…¶ä¸­çš„ locations å¹¶è¿½åŠ ã€‚</p>
      </div>
      <h2 style="margin-top:24px;">ğŸ§¾ å¯¼å‡º JSON</h2>
      <div class="controls">
        <button type="button" id="generateBtn">ç”Ÿæˆ JSON</button>
        <button type="button" class="secondary" id="copyBtn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        <button type="button" class="secondary" id="downloadBtn">ä¸‹è½½æ–‡ä»¶</button>
      </div>
      <pre id="jsonOutput" aria-label="è¾“å‡º JSON"></pre>
    </section>
  </main>
  <footer>
    <div>Made with â¤ï¸ XiaoTen-FootprintMap æ•°æ®æ„å»ºå™¨ Â· æœ¬åœ°ä¿å­˜è‰ç¨¿ï¼Œä¸ä¼šä¸Šä¼ ã€‚</div>
  </footer>

  <script src="https://webapi.amap.com/maps?v=2.0&key=4727334ebc13608dbe9ba75266c3d41a"></script>
  <script>
    const form = document.getElementById('locationForm');
    const photosListEl = document.getElementById('photosList');
    const photoInput = document.getElementById('photoInput');
    const locationListEl = document.getElementById('locationList');
    const jsonOutput = document.getElementById('jsonOutput');
    let photosTemp = [];
    let locations = [];

    // æ¢å¤è‰ç¨¿
    try { const draft = localStorage.getItem('footprintmap_builder_locations'); if (draft) locations = JSON.parse(draft); } catch(e){}

    function persistDraft(){ localStorage.setItem('footprintmap_builder_locations', JSON.stringify(locations)); }

    function renderPhotosTemp(){
      photosListEl.innerHTML = '';
      photosTemp.forEach((url,idx)=>{
        const div = document.createElement('div');
        div.className='photo-item';
        div.innerHTML = `<span>${url.replace(/^https?:\/\//,'').slice(0,40)}</span>`;
        const btn = document.createElement('button');
        btn.type='button'; btn.textContent='Ã—';
        btn.onclick=()=>{ photosTemp.splice(idx,1); renderPhotosTemp(); };
        div.appendChild(btn); photosListEl.appendChild(div);
      });
    }

    photoInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); addPhotoUrl(); }
    });
    function addPhotoUrl(){
      const v = photoInput.value.trim(); if(!v) return; photosTemp.push(v); photoInput.value=''; renderPhotosTemp();
    }

    // æ·»åŠ åœ°ç‚¹
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const date = document.getElementById('date').value.trim();
      const coordinates = document.getElementById('coordinates').value.trim();
      const markerColor = document.getElementById('markerColor').value.trim();
      if(!name||!description||!date||!coordinates||!markerColor){ alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹'); return; }
      const categoriesRaw = document.getElementById('categories').value.trim();
      const url = document.getElementById('url').value.trim();
      const urlLabel = document.getElementById('urlLabel').value.trim();
      const categories = categoriesRaw ? categoriesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
      locations.push({ name, coordinates, description, date, url, urlLabel, photos:[...photosTemp], categories, markerColor });
      photosTemp=[]; renderPhotosTemp(); form.reset(); renderLocations(); persistDraft();
    });

    document.getElementById('resetFormBtn').onclick=()=>{ form.reset(); photosTemp=[]; renderPhotosTemp(); };
    document.getElementById('clearAllBtn').onclick=()=>{ if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åœ°ç‚¹?')){ locations=[]; renderLocations(); persistDraft(); } };
    document.getElementById('removeLastBtn').onclick=()=>{ locations.pop(); renderLocations(); persistDraft(); };

    function renderLocations(){
      locationListEl.innerHTML='';
      locations.forEach((loc,idx)=>{
        const item = document.createElement('div'); item.className='location-item';
        const h = document.createElement('h3'); h.textContent = `${idx+1}. ${loc.name}`; item.appendChild(h);
        const meta = document.createElement('div'); meta.textContent = `${loc.date} Â· ${loc.coordinates}`; meta.style.fontSize='11px'; meta.style.color='#64748b'; item.appendChild(meta);
        const desc = document.createElement('div'); desc.textContent = loc.description.slice(0,120); desc.style.margin='6px 0'; item.appendChild(desc);
        if(loc.categories && loc.categories.length){ const cWrap=document.createElement('div'); loc.categories.forEach(c=>{ const span=document.createElement('span'); span.className='tag'; span.textContent=c; cWrap.appendChild(span); }); item.appendChild(cWrap); }
        if(loc.photos && loc.photos.length){ const p=document.createElement('div'); p.style.fontSize='11px'; p.style.marginTop='4px'; p.textContent = `ğŸ“¸ ${loc.photos.length} å¼ å›¾ç‰‡`; item.appendChild(p); }
        if(loc.url){ const u=document.createElement('a'); u.href=loc.url; u.target='_blank'; u.textContent= loc.urlLabel || 'é“¾æ¥'; u.style.display='inline-block'; u.style.fontSize='11px'; u.style.marginTop='4px'; item.appendChild(u); }
        const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.textContent='åˆ é™¤'; delBtn.className='danger'; delBtn.style.position='absolute'; delBtn.style.top='8px'; delBtn.style.right='8px';
        delBtn.onclick=()=>{ locations.splice(idx,1); renderLocations(); persistDraft(); };
        item.appendChild(delBtn); locationListEl.appendChild(item);
      });
    }

    // ç”Ÿæˆ JSON
    document.getElementById('generateBtn').onclick=()=>{
      const obj = { locations };
      const text = JSON.stringify(obj, null, 2);
      jsonOutput.textContent = text;
    };
    document.getElementById('copyBtn').onclick=()=>{
      if(!jsonOutput.textContent){ alert('è¯·å…ˆç”Ÿæˆ JSON'); return; }
      navigator.clipboard.writeText(jsonOutput.textContent).then(()=> alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿')); };
    document.getElementById('downloadBtn').onclick=()=>{
      if(!jsonOutput.textContent){ alert('è¯·å…ˆç”Ÿæˆ JSON'); return; }
      const blob = new Blob([jsonOutput.textContent], { type:'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'footprints.generated.json'; a.click(); URL.revokeObjectURL(a.href); };

    // å¯¼å…¥æ–‡ä»¶
    document.getElementById('importFile').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader(); reader.onload=()=>{
        try { const data = JSON.parse(reader.result); if(Array.isArray(data.locations)){ data.locations.forEach(l=>{ if(l.name && l.coordinates){ locations.push(l); } }); renderLocations(); persistDraft(); alert('å¯¼å…¥å¹¶è¿½åŠ å®Œæˆ'); } else { alert('JSON ä¸­ä¸å« locations æ•°ç»„'); } } catch(err){ alert('è§£æå¤±è´¥: '+ err.message); }
      }; reader.readAsText(file);
    });

    // åˆå§‹æ¸²æŸ“
    renderLocations(); renderPhotosTemp();

    // åœ°å›¾åˆå§‹åŒ–ä¸ç‚¹å‡»æ‹¾å–
    const map = new AMap.Map('map',{ viewMode:'2D', zoom:4, center:[105,36] });
    map.on('click', function(ev){ if(ev && ev.lnglat){ const { lng, lat } = ev.lnglat; document.getElementById('coordinates').value = lng.toFixed(6)+','+lat.toFixed(6); } });
  </script>
</body>
</html>