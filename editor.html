<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¶³è¿¹æ•°æ®æ„å»ºå™¨ - XiaoTen FootprintMap</title>
  <link rel="stylesheet" href="static/css/footprintmap.css" />
  <link rel="icon" href="data:;base64,=">
  <style>
    /* Improve mobile layout and input behavior */
    *, *::before, *::after { box-sizing: border-box; }
    html, body, input, textarea, select, button { -webkit-text-size-adjust:100%; -ms-text-size-adjust:100%; }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; background:#f5f7fa; margin:0; padding:0; max-width:100%; overflow-x:hidden; }
    header { padding:20px 24px; background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; }
    header h1 { margin:0 0 6px; font-size:22px; }
    header p { margin:0; opacity:.85; font-size:14px; }
    main { display:flex; flex-wrap:wrap; gap:20px; padding:20px 24px; max-width:1400px; margin:0 auto; }
    .panel { background:#fff; border:1px solid #e2e8f0; border-radius:10px; padding:20px 24px; flex:1 1 420px; min-width:0; max-width:100%; box-sizing:border-box; }
    .panel h2 { margin:0 0 16px; font-size:16px; color:#334155; display:flex; align-items:center; gap:6px; }
    form .group { margin-bottom:14px; }
    label { display:block; font-size:12px; font-weight:600; color:#475569; margin-bottom:5px; }
    input[type=text], input[type=date], input[type=file], textarea, select { 
      width:100%; 
      max-width:100%;
      min-width:0;
      padding:9px 12px; 
      border:1px solid #cbd5e1; 
      border-radius:6px; 
      font-size:14px; 
      background:#fff; 
      box-sizing:border-box;
      font-family: inherit;
      overflow:hidden;
    }
    input[type=text]:focus, input[type=date]:focus, textarea:focus, select:focus {
      outline:none;
      border-color:#6366f1;
    }
    /* Ensure date inputs match other text inputs in height and box sizing */
    input[type=date] { padding:9px 12px; height:42px; box-sizing:border-box; }
    /* Clear date button alignment */
    #clearDateBtn { padding:9px 12px; box-sizing:border-box; height:42px; display:inline-flex; align-items:center; justify-content:center; }
    input[type=checkbox] { cursor:pointer; }
    textarea { resize:vertical; min-height:80px; line-height:1.5; }
    .inline { display:flex; gap:12px; flex-wrap:wrap; }
    .inline .group { flex:1; min-width:0; }
    button, .btn { 
      cursor:pointer; 
      border:1px solid #6366f1; 
      background:#6366f1; 
      color:#fff; 
      padding:9px 16px; 
      font-size:14px; 
      border-radius:6px; 
      font-weight:500;
      white-space:nowrap;
    }
    button.secondary, .btn.secondary { background:#fff; color:#374151; border-color:#cbd5e1; }
    button.danger { background:#dc2626; border-color:#dc2626; }
    button:hover, .btn:hover { opacity:0.9; }
    button:active, .btn:active { opacity:0.8; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    #map { height:360px; border-radius:8px; overflow:hidden; border:1px solid #cbd5e1; margin-bottom:8px; }
    .photos-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .photos-list .photo-item { background:#f1f5f9; padding:5px 8px; border-radius:5px; font-size:11px; display:flex; align-items:center; gap:6px; border:1px solid #e2e8f0; }
    .photos-list .photo-item button { background:none; color:#dc2626; border:none; padding:0 4px; font-size:14px; cursor:pointer; line-height:1; }
    .photos-list .photo-item button:hover { color:#991b1b; }
    .location-list { height:420px; max-height:420px; min-height:420px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:10px; background:#fff; margin-bottom:12px; }
    .location-item {
      border:1px solid #e2e8f0;
      border-radius:6px;
      padding:10px 12px;
      margin-bottom:8px;
      background:#f8fafc;
      font-size:13px;
      position:relative;
      min-height:60px;
      box-sizing:border-box;
      padding-left:30px;
      padding-right:120px;
    }
    .location-item h3 {
      margin:0 0 5px;
      font-size:14px;
      color:#1f2937;
      font-weight:600;
      line-height:1.4;
    }
    .location-item .item-checkbox {
      position:absolute;
      left:8px;
      top:12px;
      width:15px;
      height:15px;
      cursor:pointer;
      accent-color:#6366f1;
    }
    .location-item .item-meta {
      font-size:11px;
      color:#64748b;
      margin-bottom:5px;
      line-height:1.5;
    }
    .location-item .item-desc {
      color:#475569;
      line-height:1.4;
      margin-bottom:5px;
      word-break:break-all;
    }
    .location-item .item-actions {
      position:absolute;
      top:50%;
      right:8px;
      transform:translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:stretch;
    }
    .location-item .item-actions button {
      padding:5px 8px;
      font-size:11px;
      min-width:44px;
      height:24px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .location-item .item-nav {
      position:absolute;
      top:50%;
      right:56px;
      transform:translateY(-50%);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .location-item .item-nav button {
      padding:3px 6px;
      font-size:12px;
      width:28px;
      height:24px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .tag { display:inline-block; background:#6366f1; color:#fff; padding:3px 8px; font-size:11px; border-radius:4px; margin-right:4px; margin-top:4px; }
    .controls { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    pre#jsonOutput { background:#0f172a; color:#e2e8f0; padding:16px; border-radius:8px; font-size:12px; overflow:auto; min-height:470px; max-height:470px; line-height:1.6; margin-top:12px; }
    footer { text-align:center; padding:30px 20px; font-size:12px; color:#64748b; }
    .split { display:flex; flex-direction:column; gap:12px; }
    .import-block { border:1px dashed #94a3b8; padding:12px; border-radius:8px; background:#f8fafc; }
    .import-block input[type=file] { padding:6px 8px; font-size:13px; }
    .small { font-size:11px; color:#64748b; margin-top:6px; line-height:1.4; }
    /* Footer ç¾åŒ– */
    footer { text-align:center; padding:18px 20px; font-size:13px; color:#64748b; display:flex; flex-direction:column; gap:6px; align-items:center; }
    footer a { color:#6366f1; text-decoration:none; border-bottom:1px dashed transparent; padding-bottom:2px; }
    footer a:hover { border-bottom-color: rgba(99,102,241,0.25); }
    /* æ—¥æœŸè¡Œåœ¨çª„å±ä¸‹ä¿æŒä¸€è¡Œå¯¹é½ï¼Œå¹¶è°ƒæ•´é«˜åº¦ */
    .date-row { display:flex; align-items:center; gap:8px; }
    .date-row .date-actions { width:86px; display:flex; align-items:center; }
    .marker-color-palette { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .marker-color-swatch { 
      width:34px; 
      height:34px; 
      border-radius:50%; 
      cursor:pointer; 
      position:relative; 
      box-shadow:0 2px 4px rgba(0,0,0,.2); 
      border:3px solid #fff; 
      outline:none;
      transition:all 0.2s;
    }
    .marker-color-swatch[data-selected="1"] { box-shadow:0 0 0 3px #6366f1; }
    .marker-color-swatch[data-none="1"] { background:#e2e8f0; display:flex; align-items:center; justify-content:center; font-size:12px; color:#475569; font-weight:700; }
    .tags-options { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
    .tag-option { 
      padding:5px 10px; 
      background:#e2e8f0; 
      color:#334155; 
      font-size:12px; 
      border-radius:16px; 
      cursor:pointer; 
      user-select:none; 
      line-height:18px; 
      display:flex; 
      align-items:center; 
      gap:4px;
      border:1px solid transparent;
    }
    .tag-option[data-selected="1"] { background:#6366f1; color:#fff; border-color:#6366f1; }
    .tag-option button { background:none; border:none; color:inherit; cursor:pointer; font-size:14px; padding:0 2px; line-height:1; }
    .tag-option button:hover { opacity:0.7; }
    @media (max-width:640px){ 
      .marker-color-swatch{ width:28px; height:28px; border-width:2px; } 
      .panel { padding:16px 18px; }
      main { padding:16px; }
      /* å¤§å¤šæ•° inline åŒºåŸŸå¯æ¢è¡Œï¼Œä½† .date-row æˆ‘ä»¬ä¿æŒä¸ºä¸€è¡Œ */
      .inline { flex-direction:column; gap:10px; }
      .date-row { flex-direction:row; }
      input[type=text], input[type=date], textarea, select, button { font-size:16px; }
      /* Mobile adjustments: keep consistent heights and smaller location list */
      input[type=date] { height:40px; padding:8px 10px; }
      #clearDateBtn { height:40px; padding:8px 10px; }
      .location-list { height:420px; max-height:420px; min-height:420px; }
      /* Ensure panels occupy full width on small screens */
      .panel { width:100%; }
    }
    @media (max-width:900px){ 
      main{ flex-direction:column; }
      .panel{ width:100%; }
    }
  </style>
</head>
<body>
  <header>
    <h1>è¶³è¿¹æ•°æ®æ„å»ºå™¨</h1>
    <p>å¯è§†åŒ–å½•å…¥åœ°ç‚¹ä¿¡æ¯ï¼Œç”Ÿæˆç¬¦åˆ XiaoTen-FootprintMap è§„èŒƒçš„ JSON æ•°æ®ã€‚</p>
    <div style="margin-top:12px;">
      <a href="index.html" style="color:#fff;text-decoration:none;opacity:0.9;font-size:13px;border:1px solid rgba(255,255,255,0.3);padding:6px 12px;border-radius:6px;display:inline-block;">â† è¿”å›æ¼”ç¤ºé¡µ</a>
    </div>
  </header>
  <main>
    <section class="panel" style="flex:1 1 480px;">
      <h2>ğŸ—ºï¸ åæ ‡æ‹¾å–</h2>
      <div style="margin:8px 0 12px; display:flex; align-items:center; gap:8px;">
        <label style="font-size:13px; color:#475569;">åœ°å›¾æä¾›å•†ï¼š</label>
        <select id="providerSelect" aria-label="é€‰æ‹©åœ°å›¾æœåŠ¡" style="padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;background:#fff;font-size:13px; width:160px;">
          <option value="amap">é«˜å¾· AMap</option>
          <option value="mapbox">Mapbox</option>
        </select>
      </div>
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <input type="text" id="placeSearchInput" placeholder="æœç´¢åœ°ç‚¹ä»¥å®šä½æ‹¾å–ï¼Œå¦‚ï¼šæ­å·è¥¿æ¹–" style="flex:1;" />
        <button type="button" class="secondary" id="placeSearchBtn">æœç´¢</button>
      </div>
      <div id="map"></div>
      <div style="margin-top:8px; margin-bottom:12px;">
        <label style="display:block; font-weight:600; margin-bottom:6px;">åæ ‡ *ï¼ˆç»åº¦,çº¬åº¦ï¼›å¯ç‚¹å‡»åœ°å›¾æ‹¾å–ï¼‰</label>
        <input type="text" id="coordinates" required placeholder="116.4074,39.9042" aria-required="true" />
      </div>

      <h2 style="margin-top:6px;">ğŸ“ åœ°ç‚¹å½•å…¥</h2>
      <form id="locationForm" autocomplete="off">
        <div id="formErrors" style="display:none; margin-bottom:12px; padding:8px 10px; border:1px solid #dc2626; background:#fef2f2; color:#b91c1c; border-radius:6px; font-size:12px;"></div>
        <div class="group">
          <label>åç§° *ï¼ˆå¿…å¡«ï¼‰</label>
          <input type="text" id="name" required placeholder="å¦‚ï¼šåŒ—äº¬" aria-required="true" />
        </div>
        <div class="group">
          <label>æè¿°ï¼ˆå¯é€‰ï¼‰</label>
          <textarea id="description" placeholder="ç®€è¦æè¿°è¯¥åœ°ç‚¹"></textarea>
        </div>
        <div class="group">
          <label>æ—¥æœŸï¼ˆå¯é€‰ï¼ŒYYYY-MM-DDï¼‰</label>
          <div class="inline date-row">
            <div style="flex:1; min-width:0;">
              <input type="date" id="date" />
            </div>
            <div class="date-actions">
              <button type="button" class="secondary" id="clearDateBtn" style="width:100%; box-sizing:border-box;">æ¸…ç©ºæ—¥æœŸ</button>
            </div>
          </div>
        </div>
        <div class="group">
          <label>æ ‡è®°é¢œè‰²ï¼ˆå¯é€‰ï¼Œæœªé€‰åˆ™è‡ªåŠ¨è½®æ¢ï¼‰</label>
          <div id="markerColorPalette" class="marker-color-palette" role="radiogroup" aria-label="é€‰æ‹©æ ‡è®°é¢œè‰²"></div>
          <input type="hidden" id="markerColor" value="" />
        </div>
        <div class="group">
          <label>åˆ†ç±»ï¼ˆå¤šé€‰ï¼Œé»˜è®¤ï¼šå¸¸é©» / æ—…è¡Œ / æ¸¸è®°ï¼‰</label>
          <div id="categoryOptions" class="tags-options" aria-label="åˆ†ç±»å¤šé€‰"></div>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <input type="text" id="newCategoryInput" placeholder="è¾“å…¥åå›è½¦æˆ–ç‚¹å‡»æ·»åŠ " style="flex:1;" />
            <button type="button" class="secondary" id="addCategoryBtn">æ·»åŠ åˆ†ç±»</button>
          </div>
          <div class="small">ç‚¹å‡»æ ‡ç­¾åˆ‡æ¢é€‰ä¸­ï¼Œè‡ªå®šä¹‰åˆ†ç±»å¯æ·»åŠ åå†ç‚¹äº®ã€‚</div>
        </div>
        <div class="group">
          <label>å›¾ç‰‡ URLï¼ˆè¾“å…¥åå›è½¦æˆ–ç‚¹å‡»æ·»åŠ ï¼‰</label>
          <div style="display:flex; gap:8px;">
            <input type="text" id="photoInput" placeholder="https://...jpg" style="flex:1;" />
            <button type="button" class="secondary" id="addPhotoBtn" style="white-space:nowrap;">æ·»åŠ å›¾ç‰‡</button>
          </div>
          <div class="photos-list" id="photosList"></div>
        </div>
        <div class="inline">
          <div class="group">
            <label>å…³è”é“¾æ¥ URL</label>
            <input type="text" id="url" placeholder="https://ä½ çš„åšå®¢æ–‡ç« " />
          </div>
          <div class="group">
            <label>é“¾æ¥æ–‡å­—</label>
            <input type="text" id="urlLabel" placeholder="é˜…è¯»æ¸¸è®°" />
          </div>
        </div>
        <div class="controls">
          <button type="submit" id="submitBtn">âœš æ·»åŠ åœ°ç‚¹</button>
          <button type="button" class="secondary" id="resetFormBtn">æ¸…ç©ºè¡¨å•</button>
          <button type="button" class="secondary" id="cancelEditBtn" style="display:none;">å–æ¶ˆç¼–è¾‘</button>
        </div>
        <p class="small">å¿…å¡«é¡¹ï¼šåç§°ã€åæ ‡ã€‚å…¶ä»–å­—æ®µå¯é€‰ä½†æ¨èå¡«å†™æè¿°/æ—¥æœŸä»¥ä¸°å¯Œä¿¡æ¯ã€‚</p>
      </form>
      
    </section>

    <section class="panel" style="flex:1 1 420px;">
      <div class="import-block" style="margin-top:0; margin-bottom:12px;">
        <label style="font-weight:600; font-size:12px;">å¯¼å…¥å·²æœ‰ JSON æ–‡ä»¶</label>
        <input type="file" id="importFile" accept="application/json" />
        <div style="margin-top:6px;">
          <label style="display:flex; align-items:center; gap:6px; font-weight:400;">
            <input type="checkbox" id="importAutoSort" />
            <span style="font-size:11px;">å¯¼å…¥åè‡ªåŠ¨æŒ‰æ—¥æœŸæ’åº</span>
          </label>
        </div>
        <p class="small">ä¼šå°è¯•è¯»å–å…¶ä¸­çš„ locations å¹¶è¿½åŠ ã€‚</p>
      </div>

      <h2 style="margin-top:6px;">JSONä»£ç </h2>
      <div class="controls">
        <button type="button" id="generateBtn">ä¸‹è½½ JSON</button>
        <button type="button" class="secondary" id="copyBtn">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
        <button type="button" class="secondary" id="toggleSortDateBtn" data-on="0">å¼€å¯æŒ‰æ—¥æœŸæ’åº</button>
      </div>
      <pre id="jsonOutput" aria-label="è¾“å‡º JSON"></pre>

      <h2 style="margin-top:12px;">ğŸ“ å·²æ·»åŠ åœ°ç‚¹</h2>
      <div class="location-list" id="locationList"></div>
      <div class="controls">
        <button type="button" class="secondary" id="clearAllBtn">æ¸…ç©ºæ‰€æœ‰</button>
        <button type="button" class="danger" id="removeLastBtn">åˆ é™¤æœ€åä¸€ä¸ª</button>
      </div>
    </section>
  </main>
  
  <div style="max-width:1400px; margin:0 auto; padding:0 24px 20px;">
    <section class="panel" style="width:100%;">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h2 style="margin:0; display:flex; align-items:center; gap:8px;">ğŸ” æ•ˆæœé¢„è§ˆ
          <button type="button" class="secondary" id="refreshPreviewBtn" style="font-size:13px; padding:7px 14px;">ğŸ”„ åˆ·æ–°é¢„è§ˆ</button>
        </h2>
        <div style="display:flex; gap:8px; align-items:center;">
              <button type="button" class="secondary" id="toggleThemeBtn" style="font-size:13px; padding:7px 14px;">ğŸŒ“ ä¸»é¢˜</button>
          </div>
      </div>
      <div id="previewMapWrap" style="margin-top:12px;">
        <div id="previewMap" class="footprint-map" style="width:100%;height:500px;" data-amap-key="4727334ebc13608dbe9ba75266c3d41a"></div>
      </div>
      <p class="small">é¢„è§ˆä¸ºæ­£å¼ FootprintMap ç»„ä»¶ï¼ˆå«èšç±»ã€ç­›é€‰ã€ä¸»é¢˜åˆ‡æ¢ç­‰ï¼‰ï¼Œå¯¼å‡ºçš„ JSON å¯ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚æ·»åŠ /ç¼–è¾‘åœ°ç‚¹åï¼Œç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"æ›´æ–°åœ°å›¾ã€‚</p>
    </section>
  </div>
  
  <footer>
    <div>Made with â¤ï¸ XiaoTen-FootprintMap æ•°æ®æ„å»ºå™¨ Â· æœ¬åœ°ä¿å­˜è‰ç¨¿ï¼Œä¸ä¼šä¸Šä¼ ã€‚</div>
    <div style="margin-top:8px;font-size:12px;color:#94a3b8;">Â© <a href="https://www.xiaoten.com" target="_blank" rel="noopener noreferrer">XiaoTen</a></div>
  </footer>

  <script>
    window._AMapSecurityConfig = {
      securityJsCode: '16835a13e9518124d6e8db523f0cdaad'
    };
  </script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=4727334ebc13608dbe9ba75266c3d41a"></script>
  <script defer src="static/js/footprintmap.js"></script>
  <script src="static/js/theme.js"></script>
  <script src="static/js/utils.js"></script>
  <!-- æœ¬åœ° Mapbox tokenï¼ˆå¯é€‰ï¼‰ï¼šå¤åˆ¶ç¤ºä¾‹ä¸º local_mapbox_token.js å¹¶å¡«å…¥çœŸå® tokenï¼ˆä¸è¦æäº¤ï¼‰ -->
  <script src="static/js/local_mapbox_token.js"></script>
  <script>
    // Mapbox tokenï¼šä¼˜å…ˆä½¿ç”¨å…¨å±€è¦†ç›–æˆ– localStorage ä¸­çš„æ³¨å…¥å€¼ï¼ˆä¾¿äºè‡ªåŠ¨åŒ–æ³¨å…¥ï¼‰ã€‚
    // æ³¨æ„ï¼šä¸è¦æŠŠé•¿æœŸæœ‰æ•ˆçš„ token æäº¤åˆ°ä»“åº“ï¼›ä»“åº“ä¸­ä¸åº”åŒ…å«ä»»ä½•å›é€€ tokenã€‚
    const MAPBOX_TOKEN = (function(){
      try{ if(window && window.__MAPBOX_TOKEN_OVERRIDE) return window.__MAPBOX_TOKEN_OVERRIDE; }catch(e){}
      try{ const t = localStorage.getItem('MAPBOX_TOKEN'); if(t) return t; }catch(e){}
      return '';
    })();

    const form = document.getElementById('locationForm');
    const photosListEl = document.getElementById('photosList');
    const photoInput = document.getElementById('photoInput');
    const locationListEl = document.getElementById('locationList');
    const jsonOutput = document.getElementById('jsonOutput');
    const formErrorsEl = document.getElementById('formErrors');
    const previewMapEl = document.getElementById('previewMap');
    let photosTemp = [];
    let locations = [];
    let editingIndex = null; // è‹¥ä¸ä¸º null åˆ™è¡¨ç¤ºå½“å‰ä¸ºç¼–è¾‘æ¨¡å¼
    let previewMapInstance = null;
    let sortByDate = false;
    let pruneEmpty = true;
    let importAutoSort = false;
    const defaultCategories = ['å¸¸é©»','æ—…è¡Œ','æ¸¸è®°'];
    let selectedCategories = new Set();
    let selectedMarkerColor = '';
    
    // localStorage è¾…åŠ©å‡½æ•°ç”±å…±äº«æ–‡ä»¶æä¾›ï¼ˆstatic/js/utils.jsï¼‰
    // å…¨å±€å¯ç›´æ¥ä½¿ç”¨ `lsGet` / `lsSet` æˆ– `Utils.lsGet` / `Utils.lsSet`

    // æ¢å¤å¯¼å…¥è‡ªåŠ¨æ’åºåå¥½
    importAutoSort = lsGet('footprintmap_builder_importAutoSort','false') === 'true';
    if(document.getElementById('importAutoSort')) document.getElementById('importAutoSort').checked = importAutoSort;
    const markerGradients = {
      sunset: 'linear-gradient(135deg, #ffb347, #ff6f61)',
      ocean: 'linear-gradient(135deg, #06beb6, #48b1bf)',
      forest: 'linear-gradient(135deg, #5ee7df, #39a37c)',
      amber: 'linear-gradient(135deg, #f6d365, #fda085)',
      violet: 'linear-gradient(135deg, #a18cd1, #fbc2eb)',
      citrus: 'linear-gradient(135deg, #fdfb8f, #a1ffce)'
    };

    // æ—¥æœŸæ ¼å¼åŒ–å·¥å…·ï¼šç»Ÿä¸€ä¸º YYYY-MM-DDï¼ˆè‹¥æ— æ³•è§£æåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²ï¼‰
    function formatDateISO(s){
      if(!s) return '';
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      // å°è¯• Date.parse è§£æå¸¸è§æ ¼å¼
      const ts = Date.parse(s);
      if(!isNaN(ts)){
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${dd}`;
      }
      // è§£æä¸­æ–‡æ ¼å¼å¦‚ 2025å¹´11æœˆ19æ—¥ æˆ– 2025å¹´11æœˆ
      const m = /^(\d{4})å¹´(\d{1,2})æœˆ(?:([0-9]{1,2})æ—¥)?/.exec(s);
      if(m){
        const y = m[1]; const mm = String(m[2]).padStart(2,'0'); const dd = m[3] ? String(m[3]).padStart(2,'0') : '01';
        return `${y}-${mm}-${dd}`;
      }
      return '';
    }
    function formatDateDisplay(s){ const iso = formatDateISO(s); return iso || ''; }

    // æ¢å¤è‰ç¨¿
    const draft = lsGet('footprintmap_builder_locations', null);
    if(draft){ try{ locations = JSON.parse(draft); locations = locations.map(l=> ({ ...l, date: formatDateISO(l.date) || l.date })); }catch(e){} }

    function persistDraft(){ lsSet('footprintmap_builder_locations', JSON.stringify(locations)); }

    function renderPhotosTemp(){
      photosListEl.innerHTML = '';
      photosTemp.forEach((url,idx)=>{
        const div = document.createElement('div');
        div.className='photo-item';
        div.innerHTML = `<span>${url.replace(/^https?:\/\//,'').slice(0,40)}</span>`;
        const btn = document.createElement('button');
        btn.type='button'; btn.textContent='Ã—';
        btn.onclick=()=>{ photosTemp.splice(idx,1); renderPhotosTemp(); };
        div.appendChild(btn); photosListEl.appendChild(div);
      });
    }

    photoInput.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ e.preventDefault(); addPhotoUrl(); }
    });
    function addPhotoUrl(){
      const v = photoInput.value.trim();
      if(!v) return;
      // æ ¡éªŒ URL æ ¼å¼
      if(!isValidUrl(v)){
        // ä¸´æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        flashFormError('å›¾ç‰‡ URL éæ³•');
        return;
      }
      // é˜²æ­¢é‡å¤æ·»åŠ ç›¸åŒå›¾ç‰‡é“¾æ¥
      if(photosTemp.includes(v)){
        flashFormError('è¯¥å›¾ç‰‡é“¾æ¥å·²æ·»åŠ ï¼Œä¸èƒ½é‡å¤æ·»åŠ ');
        photoInput.value = '';
        return;
      }
      photosTemp.push(v);
      photoInput.value = '';
      renderPhotosTemp();
    }

    // åœ¨è¡¨å•é¡¶éƒ¨çŸ­æ—¶é—ªç°é”™è¯¯ä¿¡æ¯ï¼ˆä¸å½±å“å…¶å®ƒæ ¡éªŒï¼‰
    function flashFormError(msg, duration = 2000){
      if(!formErrorsEl) return alert(msg);
      const prev = formErrorsEl.innerHTML;
      const wasVisible = formErrorsEl.style.display !== 'none' && formErrorsEl.style.display !== '';
      formErrorsEl.style.display = 'block';
      formErrorsEl.innerHTML = `<div>â€¢ ${msg}</div>`;
      setTimeout(()=>{
        if(wasVisible){ formErrorsEl.innerHTML = prev; }
        else { formErrorsEl.style.display = 'none'; formErrorsEl.textContent = ''; }
      }, duration);
    }

    // æ ¡éªŒå‡½æ•°
    function validateCoordinates(str){
      const re = /^\s*(-?\d+(?:\.\d+)?)[,ï¼Œ]\s*(-?\d+(?:\.\d+)?)\s*$/;
      const m = re.exec(str);
      if(!m) return null;
      const lng = parseFloat(m[1]); const lat = parseFloat(m[2]);
      if(Math.abs(lng)>180 || Math.abs(lat)>90) return null;
      return { lng, lat };
    }
    function isValidUrl(str){
      if(!str) return true; // ç©ºå…è®¸
      try { const u = new URL(str); return ['http:','https:'].includes(u.protocol); } catch(e){ return false; }
    }
    function collectErrors(fields){
      const errs = [];
      if(!fields.name) errs.push('åç§°ä¸èƒ½ä¸ºç©º');
      if(!fields.coordinates) errs.push('åæ ‡ä¸èƒ½ä¸ºç©º');
      if(fields.coordinates && !validateCoordinates(fields.coordinates)) errs.push('åæ ‡æ ¼å¼é”™è¯¯æˆ–èŒƒå›´éæ³• (lng,lat)');
      if(fields.url && !isValidUrl(fields.url)) errs.push('å…³è”é“¾æ¥ URL éæ³•');
      for(const p of fields.photos){ if(!isValidUrl(p)) { errs.push('å›¾ç‰‡ URL éæ³•: '+p); break; } }
      return errs;
    }
    function showErrors(errs){
      if(!errs.length){ formErrorsEl.style.display='none'; formErrorsEl.textContent=''; return; }
      formErrorsEl.style.display='block'; formErrorsEl.innerHTML = errs.map(e=>`<div>â€¢ ${e}</div>`).join('');
    }

    function clearInvalidHighlights(){
      form.querySelectorAll('.invalid').forEach(el=> el.classList.remove('invalid'));
    }
    function applyInvalidHighlights(fields){
      if(!fields.name) document.getElementById('name').classList.add('invalid');
      if(!fields.coordinates || !validateCoordinates(fields.coordinates)) document.getElementById('coordinates').classList.add('invalid');
      if(fields.url && !isValidUrl(fields.url)) document.getElementById('url').classList.add('invalid');
      if(fields.photos.some(p=>!isValidUrl(p))) photoInput.classList.add('invalid');
    }

    // æ‹–æ‹½æ’åº
    function enableDragForItems(){
      locationListEl.querySelectorAll('.location-item').forEach(item=>{
        item.draggable = true;
        item.addEventListener('dragstart', e=>{
          e.dataTransfer.setData('text/plain', item.dataset.idx);
          item.classList.add('dragging');
        });
        item.addEventListener('dragend', ()=> item.classList.remove('dragging'));
        item.addEventListener('dragover', e=> e.preventDefault());
        item.addEventListener('drop', e=>{
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData('text/plain'),10);
          const to = parseInt(item.dataset.idx,10);
          if(isNaN(from)||isNaN(to)||from===to) return;
          const moved = locations.splice(from,1)[0];
          locations.splice(to,0,moved);
          renderLocations(); persistDraft(); generateJson();
        });
      });
    }

    // åˆ†ç±»ä¸é¢œè‰²æ¸²æŸ“
    function renderCategoryOptions(){
      const wrap = document.getElementById('categoryOptions');
      if(!wrap) return;
      wrap.innerHTML='';
      const all = Array.from(new Set([...defaultCategories, ...selectedCategories]));
      all.forEach(cat=>{
        const div = document.createElement('div');
        div.className='tag-option';
        div.textContent = cat;
        div.setAttribute('role','checkbox');
        div.dataset.val = cat;
        if(selectedCategories.has(cat)) { div.dataset.selected='1'; div.setAttribute('aria-checked','true'); }
        else div.setAttribute('aria-checked','false');
        div.onclick=()=>{ if(selectedCategories.has(cat)) selectedCategories.delete(cat); else selectedCategories.add(cat); renderCategoryOptions(); };
        if(!defaultCategories.includes(cat)){
          const delBtn = document.createElement('button'); delBtn.type='button'; delBtn.title='åˆ é™¤æ ‡ç­¾'; delBtn.textContent='Ã—'; delBtn.onclick=(e)=>{ e.stopPropagation(); selectedCategories.delete(cat); renderCategoryOptions(); };
          div.appendChild(delBtn);
        }
        wrap.appendChild(div);
      });
    }
    function addCategoryFromInput(){ const inp = document.getElementById('newCategoryInput'); if(!inp) return; const v = inp.value.trim(); if(!v) return; selectedCategories.add(v); inp.value=''; renderCategoryOptions(); }
    document.getElementById('addCategoryBtn').onclick=()=> addCategoryFromInput();
    document.getElementById('newCategoryInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); addCategoryFromInput(); } });
    function getSelectedCategories(){ return Array.from(selectedCategories); }
    function initMarkerColorPalette(){
      const palette = document.getElementById('markerColorPalette'); if(!palette) return;
      const presets = Object.keys(markerGradients);
      palette.innerHTML='';
      const none = document.createElement('div'); none.className='marker-color-swatch'; none.dataset.none='1'; none.title='è‡ªåŠ¨'; none.tabIndex=0; none.textContent='A'; none.onclick=()=>{ selectedMarkerColor=''; document.getElementById('markerColor').value=''; updateMarkerSelection(); };
      palette.appendChild(none);
      presets.forEach(p=>{ const s=document.createElement('div'); s.className='marker-color-swatch'; s.style.background=markerGradients[p]; s.title=p; s.tabIndex=0; s.dataset.val=p; s.onclick=()=>{ selectedMarkerColor=p; document.getElementById('markerColor').value=p; updateMarkerSelection(); }; palette.appendChild(s); });
      updateMarkerSelection();
    }
    function updateMarkerSelection(){ document.querySelectorAll('.marker-color-swatch').forEach(el=>{ if(el.dataset.none==='1'){ el.dataset.selected = selectedMarkerColor==='' ? '1':'0'; } else { el.dataset.selected = el.dataset.val===selectedMarkerColor ? '1':'0'; } }); }

    // æ·»åŠ åœ°ç‚¹
    form.addEventListener('submit', e=>{
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const description = document.getElementById('description').value.trim();
      const date = document.getElementById('date').value.trim();
      const dateNorm = formatDateISO(date);
      const coordinates = document.getElementById('coordinates').value.trim();
      const markerColor = document.getElementById('markerColor').value.trim();
      const categories = getSelectedCategories();
      const url = document.getElementById('url').value.trim();
      const urlLabel = document.getElementById('urlLabel').value.trim();
      const draftObj = { name, coordinates, description, date: dateNorm || undefined, url, urlLabel, photos:[...photosTemp], categories, markerColor };
      const errs = collectErrors(draftObj);
      showErrors(errs);
      clearInvalidHighlights(); applyInvalidHighlights(draftObj);
      if(errs.length){ return; }
      const wasEditing = editingIndex !== null;
      if(wasEditing){
        locations[editingIndex] = draftObj;
        editingIndex = null;
        document.getElementById('submitBtn').textContent = 'âœš æ·»åŠ åœ°ç‚¹';
        document.getElementById('cancelEditBtn').style.display = 'none';
      } else {
        locations.push(draftObj);
      }
      photosTemp=[]; renderPhotosTemp(); form.reset(); renderLocations(); persistDraft(); generateJson(); selectedMarkerColor=''; document.getElementById('markerColor').value=''; selectedCategories=new Set(); renderCategoryOptions(); updateMarkerSelection();
      
      // ä»…åœ¨æ·»åŠ æ–°åœ°ç‚¹æ—¶æ»šåŠ¨åˆ°æœ€æ–°æ·»åŠ çš„åœ°ç‚¹ï¼›ç¼–è¾‘ä¿å­˜æ—¶ä¸æ»šåŠ¨
      if(!wasEditing){
        setTimeout(() => {
          const items = locationListEl.querySelectorAll('.location-item');
          if(items.length > 0) {
            const lastItem = items[items.length - 1];
            lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        }, 100);
      }
    });

    document.getElementById('resetFormBtn').onclick=()=>{ form.reset(); photosTemp=[]; renderPhotosTemp(); };
    document.getElementById('cancelEditBtn').onclick=()=>{ 
      editingIndex = null; 
      form.reset(); 
      photosTemp=[]; 
      renderPhotosTemp(); 
      showErrors([]);
      selectedMarkerColor=''; 
      document.getElementById('markerColor').value=''; 
      selectedCategories=new Set(); 
      renderCategoryOptions(); 
      updateMarkerSelection();
      document.getElementById('submitBtn').textContent = 'âœš æ·»åŠ åœ°ç‚¹';
      document.getElementById('cancelEditBtn').style.display = 'none';
    };
    document.getElementById('clearAllBtn').onclick=()=>{ if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰åœ°ç‚¹?')){ locations=[]; renderLocations(); persistDraft(); jsonOutput.textContent=''; const wrap = document.getElementById('previewMapWrap'); const previewMapEl = document.getElementById('previewMap'); if(previewMapEl) previewMapEl.innerHTML='<div style="padding:20px;font-size:13px;color:#64748b;text-align:center;height:500px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:8px;">æš‚æ— è¶³è¿¹æ•°æ®ï¼Œè¯·æ·»åŠ åœ°ç‚¹ã€å¯¼å…¥ JSON æ–‡ä»¶æˆ–å¯¼å…¥ç¤ºä¾‹æ•°æ®ï¼Œç„¶åç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"ã€‚</div>'; } };

    
    document.getElementById('removeLastBtn').onclick=()=>{
      // åˆ é™¤æœ€åä¸€ä¸ªå¹¶ä¿æŒ UI ä¸æ•°æ®åŒæ­¥
      locations.pop();
      renderLocations();
      persistDraft();
      generateJson();
      // åˆ é™¤åèšç„¦åˆ°æ–°çš„æœ€åä¸€é¡¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      setTimeout(()=>{
        const items = locationListEl.querySelectorAll('.location-item');
        if(items.length > 0){
          const last = items[items.length - 1];
          last.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      }, 80);
    };

    // æ¸…ç©ºæ—¥æœŸæŒ‰é’®
    const clearDateBtn = document.getElementById('clearDateBtn');
    if(clearDateBtn){
      clearDateBtn.addEventListener('click', ()=>{ document.getElementById('date').value = ''; });
    }

    function renderLocations(){
      locationListEl.innerHTML='';
      locations.forEach((loc,idx)=>{
        const item = document.createElement('div'); 
        item.className='location-item';
        item.dataset.idx = idx;
        
        // å¤é€‰æ¡†
        const checkbox = document.createElement('input');
        checkbox.type='checkbox'; 
        checkbox.className='loc-select item-checkbox';
        item.appendChild(checkbox);
        
        // æ ‡é¢˜
        const h = document.createElement('h3'); 
        h.textContent = `${idx+1}. ${loc.name}`; 
        item.appendChild(h);
        
        // å…ƒä¿¡æ¯
        const meta = document.createElement('div'); 
        meta.className='item-meta';
        meta.textContent = `${formatDateDisplay(loc.date) || 'æœªæŒ‡å®šæ—¥æœŸ'} Â· ${loc.coordinates}`; 
        item.appendChild(meta);
        
        // æè¿°
        if(loc.description){
          const desc = document.createElement('div'); 
          desc.className='item-desc';
          desc.textContent = loc.description.slice(0,120) + (loc.description.length > 120 ? '...' : ''); 
          item.appendChild(desc);
        }
        
        // åˆ†ç±»æ ‡ç­¾
        if(loc.categories && loc.categories.length){ 
          const cWrap=document.createElement('div'); 
          cWrap.style.marginTop='8px';
          loc.categories.forEach(c=>{ 
            const span=document.createElement('span'); 
            span.className='tag'; 
            span.textContent=c; 
            cWrap.appendChild(span); 
          }); 
          item.appendChild(cWrap); 
        }
        
        // å›¾ç‰‡å’Œé“¾æ¥
        const extraInfo = document.createElement('div');
        extraInfo.style.marginTop='6px';
          extraInfo.style.fontSize='12px';
        extraInfo.style.color='#64748b';
        if(loc.photos && loc.photos.length){ 
          const photoSpan = document.createElement('span');
          photoSpan.textContent = `ğŸ“¸ ${loc.photos.length} å¼ å›¾ç‰‡`;
          extraInfo.appendChild(photoSpan);
        }
        if(loc.url){ 
          if(loc.photos && loc.photos.length) {
            extraInfo.appendChild(document.createTextNode(' Â· '));
          }
          const u=document.createElement('a'); 
          u.href=loc.url; 
          u.target='_blank'; 
          u.textContent= loc.urlLabel || 'ğŸ”— é“¾æ¥'; 
          u.style.color='#6366f1';
          u.style.textDecoration='none';
          extraInfo.appendChild(u); 
        }
        if(loc.photos?.length || loc.url) item.appendChild(extraInfo);
        
        // æ“ä½œæŒ‰é’®ç»„
        const actionsDiv = document.createElement('div');
        actionsDiv.className='item-actions';
        
        const editBtn = document.createElement('button'); 
        editBtn.type='button'; 
        editBtn.textContent='ç¼–è¾‘'; 
        editBtn.className='secondary';
        editBtn.onclick=()=>{
          editingIndex = idx;
          document.getElementById('name').value = loc.name;
          document.getElementById('description').value = loc.description || '';
          document.getElementById('date').value = formatDateISO(loc.date) || '';
          document.getElementById('coordinates').value = loc.coordinates;
          selectedCategories = new Set(loc.categories||[]); renderCategoryOptions();
          selectedMarkerColor = loc.markerColor || ''; 
          document.getElementById('markerColor').value = selectedMarkerColor; 
          updateMarkerSelection();
          document.getElementById('url').value = loc.url || '';
          document.getElementById('urlLabel').value = loc.urlLabel || '';
          photosTemp = [...(loc.photos||[])]; renderPhotosTemp();
          showErrors([]);
          document.getElementById('submitBtn').textContent = 'âœ” ä¿å­˜ä¿®æ”¹';
          document.getElementById('cancelEditBtn').style.display = 'inline-block';
            // å¼ºåˆ¶æ»šåŠ¨å¹¶èšç„¦åˆ°åæ ‡è¾“å…¥ï¼Œç¡®ä¿ç”¨æˆ·èƒ½ç›´æ¥ç¼–è¾‘åæ ‡
            const coordsEl = document.getElementById('coordinates');
            if(coordsEl && typeof coordsEl.scrollIntoView === 'function'){
              // è®¡ç®—ç›®æ ‡ä½ç½®å¹¶ç²¾ç¡®æ»šåŠ¨åˆ°åæ ‡è¾“å…¥ï¼Œé¿å…è¢«åœ°å›¾æˆ–å…¶ä»– DOM é‡æ’å½±å“
              try{
                const headerEl = document.querySelector('header');
                const headerHeight = headerEl ? headerEl.offsetHeight + 12 : 80;
                const rect = coordsEl.getBoundingClientRect();
                const targetY = window.pageYOffset + rect.top - headerHeight;
                window.scrollTo({ top: Math.max(0, Math.floor(targetY)), behavior: 'smooth' });
              }catch(e){ try{ coordsEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }catch(_){} }
              // åœ¨çŸ­æ—¶å»¶åå†èšç„¦å¹¶é€‰ä¸­ï¼Œé¿å…ä¸æ»šåŠ¨/é‡æ’å†²çª
              setTimeout(()=>{
                try{ coordsEl.focus({ preventScroll: true }); if(typeof coordsEl.select === 'function') coordsEl.select(); }catch(e){}
              }, 260);
            } else {
              // å›é€€åˆ°é¡µé¢é¡¶éƒ¨ä»¥ä¿è¯è¡¨å•å¯è§
              window.scrollTo({ top:0, behavior:'smooth' });
              setTimeout(()=>{ try{ if(coordsEl) coordsEl.focus(); }catch(e){} }, 300);
            }
        };
        
        const delBtn = document.createElement('button'); 
        delBtn.type='button'; 
        delBtn.textContent='åˆ é™¤'; 
        delBtn.className='danger';
        delBtn.onclick=()=>{ 
          locations.splice(idx,1); 
          renderLocations(); 
          persistDraft(); 
          generateJson();
        };
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(delBtn);
        item.appendChild(actionsDiv);
        
        // ä¸Šä¸‹ç§»åŠ¨æŒ‰é’®
        const navDiv = document.createElement('div');
        navDiv.className='item-nav';
        
        const upBtn = document.createElement('button'); 
        upBtn.type='button'; 
        upBtn.innerHTML='â†‘'; 
        upBtn.className='secondary';
        upBtn.title='ä¸Šç§»';
        upBtn.onclick=()=>{ 
          if(idx>0){ 
            const mv=locations.splice(idx,1)[0]; 
            locations.splice(idx-1,0,mv); 
            renderLocations(); 
            persistDraft(); 
            generateJson(); 
          } 
        };
        
        const downBtn = document.createElement('button'); 
        downBtn.type='button'; 
        downBtn.innerHTML='â†“'; 
        downBtn.className='secondary';
        downBtn.title='ä¸‹ç§»';
        downBtn.onclick=()=>{ 
          if(idx < locations.length-1){ 
            const mv=locations.splice(idx,1)[0]; 
            locations.splice(idx+1,0,mv); 
            renderLocations(); 
            persistDraft(); 
            generateJson(); 
          } 
        };
        
        navDiv.appendChild(upBtn);
        navDiv.appendChild(downBtn);
        item.appendChild(navDiv);
        
        locationListEl.appendChild(item);
      });
      enableDragForItems();
    }

    // ç”Ÿæˆ JSON
    function generateJson(){
      let exportLocations = locations.map(l=> ({ ...l }));
      if(sortByDate){
        exportLocations.sort((a,b)=>{
          const da = Date.parse(a.date||'');
          const db = Date.parse(b.date||'');
          if(isNaN(da) && isNaN(db)) return 0;
          if(isNaN(da)) return 1;
          if(isNaN(db)) return -1;
          return db - da;
        });
      }
      if(pruneEmpty){
        exportLocations = exportLocations.map(obj=>{
          const cleaned = { name: obj.name, coordinates: obj.coordinates };
          ['description','date','url','urlLabel','photos','categories','markerColor'].forEach(k=>{
            const v = obj[k];
            if(v===undefined || v===null) return;
            if(typeof v==='string' && v.trim()==='') return;
            if(Array.isArray(v) && v.length===0) return;
            cleaned[k]=v;
          });
          return cleaned;
        });
      }
      const obj = { locations: exportLocations };
      const text = JSON.stringify(obj, null, 2);
      jsonOutput.textContent = text;
    }
    document.getElementById('generateBtn').onclick=()=>{
      // ç”Ÿæˆå¹¶ç›´æ¥ä¸‹è½½ JSON
      generateJson();
      const text = jsonOutput.textContent || '';
      if(!text){ alert('è¯·å…ˆç”Ÿæˆ JSON'); return; }
      try{
        const blob = new Blob([text], { type:'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'footprints.generated.json'; a.click(); URL.revokeObjectURL(a.href);
      }catch(e){ alert('ä¸‹è½½å¤±è´¥: '+ (e && e.message? e.message : e)); }
      // åŒæ—¶åˆ·æ–°é¢„è§ˆ
      renderPreviewMap();
    };
    document.getElementById('copyBtn').onclick=()=>{
      if(!jsonOutput.textContent){ alert('è¯·å…ˆç”Ÿæˆ JSON'); return; }
      navigator.clipboard.writeText(jsonOutput.textContent).then(()=> alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
    };
    document.getElementById('toggleSortDateBtn').onclick=()=>{ sortByDate = !sortByDate; document.getElementById('toggleSortDateBtn').textContent = sortByDate ? 'å…³é—­æŒ‰æ—¥æœŸæ’åº' : 'å¼€å¯æŒ‰æ—¥æœŸæ’åº'; generateJson(); };

    // åœ¨å¯¼å‡ºæ§ä»¶åŒºåŸŸï¼ˆæŒ‰æ—¥æœŸæ’åºæŒ‰é’®åï¼‰æ’å…¥â€œå¯¼å…¥ç¤ºä¾‹æ•°æ®â€æŒ‰é’®ï¼Œé¢œè‰²æ”¹ä¸ºç»¿è‰²ä»¥åŒºåˆ«äºè“/ç™½/çº¢
    (function insertImportSampleAfterSort(){
      try{
        const sortBtn = document.getElementById('toggleSortDateBtn');
        if(!sortBtn) return;
        const importSampleBtn2 = document.createElement('button');
        importSampleBtn2.type = 'button';
        importSampleBtn2.className = 'secondary';
        // ä¸ä½¿ç”¨å•ä¸ªæŒ‰é’®çš„ left marginï¼ˆä¼šåœ¨æ¢è¡Œæ—¶å¯¼è‡´ç¬¬äºŒè¡Œç¼©è¿›ï¼‰
        // æ”¹ä¸ºç¡®ä¿çˆ¶å®¹å™¨ä½¿ç”¨ gap ä¸å…è®¸æ¢è¡Œï¼Œä»è€Œåœ¨æ¢è¡Œæ—¶å„è¡Œå·¦å¯¹é½
        try{ if(sortBtn.parentNode){ sortBtn.parentNode.style.display = 'flex'; sortBtn.parentNode.style.gap = '8px'; sortBtn.parentNode.style.flexWrap = 'wrap'; } }catch(e){}
        // ä½¿ç”¨ç»¿è‰²èƒŒæ™¯åŒºåˆ†
        importSampleBtn2.style.background = '#10b981';
        importSampleBtn2.style.borderColor = '#10b981';
        importSampleBtn2.style.color = '#fff';
        importSampleBtn2.textContent = 'å¯¼å…¥ç¤ºä¾‹æ•°æ®';
        importSampleBtn2.title = 'ä» static/data/footprints.example.json åŠ è½½ç¤ºä¾‹æ•°æ®ï¼ˆå°†æ›¿æ¢å½“å‰æ•°æ®ï¼‰';
        importSampleBtn2.onclick = async ()=>{
          if(!confirm('å°†ç”¨ç¤ºä¾‹æ•°æ®æ›¿æ¢å½“å‰å·²æ·»åŠ çš„åœ°ç‚¹ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) return;
          try{
            const res = await fetch('./static/data/footprints.example.json');
            if(!res.ok) throw new Error('æ— æ³•åŠ è½½ç¤ºä¾‹æ•°æ®');
            const data = await res.json();
            if(!data || !Array.isArray(data.locations)) throw new Error('ç¤ºä¾‹æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
            locations = data.locations.filter(l=> l && l.name && l.coordinates).map(l=> ({ ...l, date: formatDateISO(l.date) || l.date }));
            renderLocations(); renderPhotosTemp(); persistDraft(); generateJson(); renderPreviewMap();
            alert('ç¤ºä¾‹æ•°æ®å·²åŠ è½½');
          }catch(err){ alert('åŠ è½½ç¤ºä¾‹æ•°æ®å¤±è´¥ï¼š' + (err && err.message ? err.message : err)); }
        };
        // æ’å…¥åˆ° sortBtn ä¹‹å
        if(sortBtn.parentNode){
          sortBtn.parentNode.insertBefore(importSampleBtn2, sortBtn.nextSibling);
        }
      }catch(e){ console.warn('æ’å…¥å¯¼å…¥ç¤ºä¾‹æ•°æ®æŒ‰é’®å¤±è´¥', e); }
    })();
    document.getElementById('refreshPreviewBtn').onclick=()=>{ renderPreviewMap(); };
    // ä¸»é¢˜åˆ‡æ¢ç”± shared script ç®¡ç†ï¼ŒæŒ‰é’®æ–‡æœ¬ä¸ demo ä¿æŒä¸€è‡´
    if(window.Theme) Theme.init({ btnId: 'toggleThemeBtn', previewSelector: '#previewMapWrap' });
    // æ‰¹é‡åˆ é™¤æŒ‰é’®é€»è¾‘
    const deleteSelectedBtn = document.createElement('button');
    deleteSelectedBtn.type='button'; deleteSelectedBtn.className='danger'; deleteSelectedBtn.textContent='æ‰¹é‡åˆ é™¤é€‰ä¸­';
    deleteSelectedBtn.onclick=()=>{
      const selectedIdx = [];
      locationListEl.querySelectorAll('.location-item').forEach((el,i)=>{ const cb = el.querySelector('.loc-select'); if(cb && cb.checked) selectedIdx.push(i); });
      if(!selectedIdx.length) { alert('æœªé€‰æ‹©ä»»ä½•åœ°ç‚¹'); return; }
      if(!confirm('ç¡®å®šåˆ é™¤é€‰ä¸­çš„ '+ selectedIdx.length +' ä¸ªåœ°ç‚¹?')) return;
      // ä»æœ«å°¾å¼€å§‹åˆ é™¤é¿å…ç´¢å¼•åç§»
      selectedIdx.sort((a,b)=>b-a).forEach(idx=> locations.splice(idx,1));
      renderLocations(); persistDraft(); generateJson();
    };
    // å°†æ‰¹é‡åˆ é™¤æŒ‰é’®åŒ…è£¹åœ¨ä¸€ä¸ªå¸¦åº•éƒ¨å¤–è¾¹è·çš„å®¹å™¨ä¸­ï¼Œé¿å…ä¸ä¸Šæ–¹æ§ä»¶ç´§é‚»
    const deleteBtnWrap = document.createElement('div');
    deleteBtnWrap.style.marginBottom = '18px';
    deleteBtnWrap.appendChild(deleteSelectedBtn);
    document.getElementById('locationList').insertAdjacentElement('beforebegin', deleteBtnWrap);

    // æ·»åŠ å›¾ç‰‡æŒ‰é’®
    document.getElementById('addPhotoBtn').onclick=()=>{ addPhotoUrl(); };

    // å¯¼å…¥æ–‡ä»¶
    document.getElementById('importFile').addEventListener('change', e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader(); reader.onload=()=>{
        try { 
          const data = JSON.parse(reader.result); 
          if(Array.isArray(data.locations)){ 
            data.locations.forEach(l=>{ if(l.name && l.coordinates){ locations.push({ ...l, date: formatDateISO(l.date) || l.date }); } }); 
            // å¦‚æœå¯ç”¨å¯¼å…¥è‡ªåŠ¨æ’åº
            if(importAutoSort){
              locations.sort((a,b)=>{
                const da = Date.parse(a.date||'');
                const db = Date.parse(b.date||'');
                if(isNaN(da) && isNaN(db)) return 0;
                if(isNaN(da)) return 1;
                if(isNaN(db)) return -1;
                return db - da;
              });
            }
            renderLocations(); persistDraft(); generateJson(); alert('å¯¼å…¥å¹¶è¿½åŠ å®Œæˆ' + (importAutoSort ? 'ï¼ˆå·²æŒ‰æ—¥æœŸæ’åºï¼‰':'')); 
          } else { alert('JSON ä¸­ä¸å« locations æ•°ç»„'); } 
        } catch(err){ alert('è§£æå¤±è´¥: '+ err.message); }
      }; reader.readAsText(file);
    });
    
    // ä¿å­˜å¯¼å…¥è‡ªåŠ¨æ’åºåå¥½
    document.getElementById('importAutoSort').addEventListener('change', e=>{
      importAutoSort = e.target.checked;
      lsSet('footprintmap_builder_importAutoSort', importAutoSort.toString());
    });

    // åˆå§‹æ¸²æŸ“ï¼ˆä¸å†è‡ªåŠ¨åŠ è½½ç¤ºä¾‹æ•°æ®ï¼Œåˆå§‹çŠ¶æ€ä¿æŒä¸ºç©ºï¼‰
    (function initialRender(){
      const savedProvider = lsGet('footprintmap_builder_provider','mapbox');
      // è‹¥å­˜åœ¨åœ°ç‚¹æ•°æ®åˆ™æ¸²æŸ“å¹¶ç”Ÿæˆé¢„è§ˆï¼Œä¿è¯åœ¨åˆ·æ–°åä½¿ç”¨ä¸Šæ¬¡é€‰æ‹©çš„ provider
      if(locations && locations.length>0){
        renderLocations(); renderPhotosTemp(); generateJson(); renderPreviewMap();
        return;
      }
      // æ— åœ°ç‚¹æ•°æ®ï¼šä»æ¸²æŸ“åˆ—è¡¨å’Œå ä½æç¤ºï¼ŒåŒæ—¶ç¡®ä¿ preview ä½¿ç”¨ä¿å­˜çš„ providerï¼ˆé¿å…åˆ·æ–°åæ˜¾ç¤ºé»˜è®¤ AMapï¼‰
      renderLocations(); renderPhotosTemp();
      try{
        const wrap = document.getElementById('previewMapWrap');
        const previewMapEl = document.getElementById('previewMap');
        if(wrap && previewMapEl){
          // å°† previewMap çš„ provider ä¸ key è®¾ç½®ä¸ºä¸Šæ¬¡é€‰æ‹©ï¼Œä¾¿äºåç»­åˆ‡æ¢ä¸€è‡´æ€§
          previewMapEl.dataset.provider = savedProvider;
          previewMapEl.dataset.amapKey = savedProvider === 'mapbox' ? MAPBOX_TOKEN : '4727334ebc13608dbe9ba75266c3d41a';
          if(!wrap._initialized){
            previewMapEl.innerHTML = '<div style="padding:20px;font-size:13px;color:#64748b;text-align:center;height:500px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:8px;">æš‚æ— è¶³è¿¹æ•°æ®ï¼Œè¯·æ·»åŠ åœ°ç‚¹ã€å¯¼å…¥ JSON æ–‡ä»¶æˆ–å¯¼å…¥ç¤ºä¾‹æ•°æ®ï¼Œç„¶åç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"ã€‚</div>';
            wrap._initialized = true;
          }
        }
      }catch(e){/* ignore */}
    })();

    // åœ°å›¾æ‹¾å–ä¸æœç´¢ï¼ˆæ”¯æŒ AMap ä¸ Mapboxï¼‰
    let amapPickerMap = null;
    let mapboxPickerMap = null;
    let mapboxPickerMarker = null;
    let amapPlaceSearch = null;

    function ensureMapboxAdapterScriptInEditor(){
      return new Promise((resolve,reject)=>{
        if(window.loadMapboxAdapter && window.mapboxgl) return resolve();
        if(document.querySelector('script[src="static/js/mapbox-adapter.js"]')){
          // already injected, wait for loader
          const check = () => { if(window.loadMapboxAdapter) return resolve(); setTimeout(check,50); };
          check();
          return;
        }
        const s = document.createElement('script'); s.src = 'static/js/mapbox-adapter.js'; s.async = true;
        s.onload = () => { const wait = () => { if(window.loadMapboxAdapter) return resolve(); setTimeout(wait,50); }; wait(); };
        s.onerror = () => reject(new Error('åŠ è½½ mapbox-adapter.js å¤±è´¥'));
        document.head.appendChild(s);
      });
    }

    async function initPickerMap(){
      // ä¼˜å…ˆä½¿ç”¨ localStorage ä¸­ä¿å­˜çš„ providerï¼Œé¿å…é¡µé¢åˆ·æ–°å DOM select çš„é»˜è®¤å€¼è¦†ç›–
      const savedProvider = lsGet('footprintmap_builder_provider', null);
      const provider = savedProvider || document.getElementById('providerSelect')?.value || 'mapbox';
      const mapEl = document.getElementById('map');
      // æ¸…ç†å®¹å™¨ä¸å·²å­˜åœ¨å®ä¾‹
      mapEl.innerHTML = '';
      if(amapPickerMap){ try{ amapPickerMap.destroy && amapPickerMap.destroy(); }catch(e){} amapPickerMap = null; }
      if(mapboxPickerMap){ try{ mapboxPickerMap.remove(); }catch(e){} mapboxPickerMap = null; }
      mapboxPickerMarker = null;

      if(provider === 'mapbox'){
        try{
          await ensureMapboxAdapterScriptInEditor();
          if(typeof window.loadMapboxAdapter === 'function') await window.loadMapboxAdapter();
          // åˆå§‹åŒ– Mapbox åœ°å›¾ç”¨äºæ‹¾å–ï¼ˆWGS84ï¼‰ï¼Œä¸­å¿ƒä½¿ç”¨ä¸­å›½èŒƒå›´
          mapboxgl.accessToken = MAPBOX_TOKEN;
          mapboxPickerMap = new mapboxgl.Map({ container: 'map', style: document.documentElement.classList.contains('dark') ? 'mapbox://styles/mapbox/dark-v10' : 'mapbox://styles/mapbox/light-v10', center:[105,36], zoom:4 });
          mapboxPickerMap.on('click', (e)=>{
            const lng = e.lngLat.lng; const lat = e.lngLat.lat;
            // å°† WGS84 è½¬ä¸º GCJ-02 å­˜å‚¨ï¼Œè‹¥è½¬æ¢å‡½æ•°å¯ç”¨åˆ™ä½¿ç”¨ä¹‹
            let outLng = lng, outLat = lat;
            if(typeof window.wgs84togcj02 === 'function'){
              const p = window.wgs84togcj02(lng, lat); outLng = p[0]; outLat = p[1];
            }
            document.getElementById('coordinates').value = outLng.toFixed(6)+','+outLat.toFixed(6);
            // æ ‡è®°
            if(mapboxPickerMarker) mapboxPickerMarker.remove();
            const el = document.createElement('div'); el.style.width='20px'; el.style.height='20px'; el.style.background='rgba(99,102,241,0.9)'; el.style.borderRadius='50%'; el.style.border='2px solid white';
            mapboxPickerMarker = new mapboxgl.Marker({ element: el }).setLngLat([lng, lat]).addTo(mapboxPickerMap);
          });
        }catch(err){ console.warn('åˆå§‹åŒ– Mapbox æ‹¾å–åœ°å›¾å¤±è´¥', err); mapEl.innerHTML = '<div style="padding:16px;color:#64748b">Mapbox åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– tokenã€‚</div>'; }
      } else {
        // AMap
        try{
          amapPickerMap = new AMap.Map('map',{ viewMode:'2D', zoom:4, center:[105,36] });
          amapPickerMap.on('click', function(ev){ if(ev && ev.lnglat){ const { lng, lat } = ev.lnglat; document.getElementById('coordinates').value = lng.toFixed(6)+','+lat.toFixed(6); amapPickerMap.clearMap(); new AMap.Marker({ position: [lng, lat], map: amapPickerMap }); } });
          AMap.plugin('AMap.PlaceSearch', ()=>{ amapPlaceSearch = new AMap.PlaceSearch({ pageSize: 10, pageIndex: 1 }); });
        }catch(e){ console.warn('åˆå§‹åŒ– AMap æ‹¾å–å¤±è´¥', e); mapEl.innerHTML = '<div style="padding:16px;color:#64748b">AMap åˆå§‹åŒ–å¤±è´¥</div>'; }
      }
    }

    // å¯åŠ¨åˆå§‹ picker
    initPickerMap();

    // provider åˆ‡æ¢æ—¶ä¹Ÿé‡å»º picker
    const providerSel = document.getElementById('providerSelect');
    if(providerSel) providerSel.addEventListener('change', ()=>{ lsSet('footprintmap_builder_provider', providerSel.value); initPickerMap(); });

    document.getElementById('placeSearchBtn').onclick=()=> doPlaceSearch();
    document.getElementById('placeSearchInput').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doPlaceSearch(); } });

    async function doPlaceSearch(){
      const kw = document.getElementById('placeSearchInput').value.trim();
      if(!kw) return;
      const provider = document.getElementById('providerSelect')?.value || lsGet('footprintmap_builder_provider','mapbox');
      if(provider === 'mapbox'){
        try{
          await ensureMapboxAdapterScriptInEditor(); if(typeof window.loadMapboxAdapter === 'function') await window.loadMapboxAdapter();
          const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(kw)}.json?access_token=${MAPBOX_TOKEN}&limit=5`;
          const res = await fetch(url);
          if(!res.ok) throw new Error('Mapbox åœ°ç†ç¼–ç è¯·æ±‚å¤±è´¥');
          const data = await res.json();
          if(data && data.features && data.features.length){
            const f = data.features[0];
            const [lng, lat] = f.center; // WGS84
            // å°† WGS84 è½¬ä¸º GCJ-02 å†™å…¥è¾“å…¥
            let outLng = lng, outLat = lat;
            if(typeof window.wgs84togcj02 === 'function'){ const p = window.wgs84togcj02(lng, lat); outLng = p[0]; outLat = p[1]; }
            document.getElementById('coordinates').value = outLng.toFixed(6)+','+outLat.toFixed(6);
            // åœ¨ mapbox picker ä¸Šæ·»åŠ æ ‡è®°å¹¶ç§»åŠ¨è§†é‡
            if(mapboxPickerMap){
              if(mapboxPickerMarker) mapboxPickerMarker.remove();
              const el = document.createElement('div'); el.style.width='20px'; el.style.height='20px'; el.style.background='rgba(99,102,241,0.9)'; el.style.borderRadius='50%'; el.style.border='2px solid white';
              mapboxPickerMarker = new mapboxgl.Marker({ element: el }).setLngLat([lng, lat]).addTo(mapboxPickerMap);
              mapboxPickerMap.easeTo({ center:[lng,lat], zoom:14 });
            }
            alert('å·²å®šä½åˆ°ï¼š' + (f.place_name || kw));
            return;
          }
          alert('æœªæ‰¾åˆ°ç»“æœ');
        }catch(err){ alert('æœç´¢å¤±è´¥ï¼š'+ (err && err.message? err.message : err)); }
        return;
      }
      // provider === 'amap'
      if(!amapPlaceSearch){ alert('æœç´¢æœåŠ¡å°šæœªå°±ç»ªï¼Œè¯·ç¨åå†è¯•'); return; }
      amapPlaceSearch.search(kw, (status, result)=>{
        console.log('æœç´¢çŠ¶æ€:', status, 'ç»“æœ:', result);
        if(status === 'complete' && result.poiList && result.poiList.pois && result.poiList.pois.length > 0){
          const poi = result.poiList.pois[0];
          if(poi.location){ 
            const lng = poi.location.lng; const lat = poi.location.lat; 
            if(amapPickerMap){ amapPickerMap.setZoomAndCenter(14, [lng, lat]); amapPickerMap.clearMap(); new AMap.Marker({ position: [lng, lat], map: amapPickerMap }); }
            document.getElementById('coordinates').value = lng.toFixed(6)+','+lat.toFixed(6);
            alert('å·²å®šä½åˆ°ï¼š' + poi.name);
          } else { alert('æ‰¾åˆ°åœ°ç‚¹ä½†æ— åæ ‡ä¿¡æ¯ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯'); }
        } else if(status === 'no_data') { alert('æœªæ‰¾åˆ°"' + kw + '"ï¼Œè¯·å°è¯•æ›´å…·ä½“çš„å…³é”®è¯'); } else if(status === 'error') { alert('æœç´¢å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•'); } else { alert('æœªæ‰¾åˆ°ç›¸å…³åœ°ç‚¹ï¼Œè¯·å°è¯•æ›´å…·ä½“çš„å…³é”®è¯'); }
      });
    }

    // é¢„è§ˆåœ°å›¾æ¸²æŸ“ï¼ˆä½¿ç”¨ç®€åŒ–ç‰ˆæ ‡è®°ï¼‰
    // é¢„è§ˆåŒºç›´æ¥ç”¨ footprint-map ç»„ä»¶æ¸²æŸ“
    function renderPreviewMap(){
      const wrap = document.getElementById('previewMapWrap');
      const previewMapEl = document.getElementById('previewMap');
      if(!previewMapEl) return;
      if(!locations.length){ 
        // åªåœ¨åˆå§‹åŒ–æ—¶æ˜¾ç¤ºæç¤ºï¼Œä¸æ¸…ç©ºå·²æœ‰å†…å®¹
        if(!wrap._initialized) {
          previewMapEl.innerHTML='<div style="padding:20px;font-size:13px;color:#64748b;text-align:center;height:500px;display:flex;align-items:center;justify-content:center;background:#f8fafc;border-radius:8px;">æš‚æ— è¶³è¿¹æ•°æ®ï¼Œè¯·æ·»åŠ åœ°ç‚¹ã€å¯¼å…¥ JSON æ–‡ä»¶æˆ–å¯¼å…¥ç¤ºä¾‹æ•°æ®ï¼Œç„¶åç‚¹å‡»"åˆ·æ–°é¢„è§ˆ"ã€‚</div>'; 
          wrap._initialized = true;
        }
        return; 
      }
      // ç”Ÿæˆä¸´æ—¶æ•°æ®æ–‡ä»¶ Blob
      let exportLocations = locations.map(l=> ({ ...l }));
      if(sortByDate){
        exportLocations.sort((a,b)=>{
          const da = Date.parse(a.date||'');
          const db = Date.parse(b.date||'');
          if(isNaN(da) && isNaN(db)) return 0;
          if(isNaN(da)) return 1;
          if(isNaN(db)) return -1;
          return db - da;
        });
      }
      if(pruneEmpty){
        exportLocations = exportLocations.map(obj=>{
          const cleaned = { name: obj.name, coordinates: obj.coordinates };
          ['description','date','url','urlLabel','photos','categories','markerColor'].forEach(k=>{
            const v = obj[k];
            if(v===undefined || v===null) return;
            if(typeof v==='string' && v.trim()==='') return;
            if(Array.isArray(v) && v.length===0) return;
            cleaned[k]=v;
          });
          return cleaned;
        });
      }
      const obj = { locations: exportLocations };
      const blob = new Blob([JSON.stringify(obj)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      
      // é‡Šæ”¾æ—§ blob
      if(wrap._lastBlobUrl && wrap._lastBlobUrl!==url){
        URL.revokeObjectURL(wrap._lastBlobUrl);
      }
      wrap._lastBlobUrl = url;
      
      // å®Œå…¨é‡å»ºå®¹å™¨
      // ä½¿ç”¨ Mapbox è¿›è¡Œé¢„è§ˆï¼ˆprovider å¯æ”¹ä¸º 'amap'ï¼‰
      // æ ¹æ®å½“å‰ provider é€‰æ‹©æ„å»º previewMap å®¹å™¨ï¼ˆprovider: 'amap' æˆ– 'mapbox'ï¼‰
      const providerSelectEl = document.getElementById('providerSelect');
      // ä¼˜å…ˆä½¿ç”¨ localStorage ä¸­ä¿å­˜çš„ providerï¼Œä»¥é¿å…åœ¨é¡µé¢åˆ·æ–°æ—¶è¢« DOM ä¸­é»˜è®¤å±æ€§è¦†ç›–
      const savedProvider = lsGet('footprintmap_builder_provider', null);
      const provider = savedProvider || (providerSelectEl ? providerSelectEl.value : 'mapbox');
      const key = provider === 'mapbox' ? MAPBOX_TOKEN : '4727334ebc13608dbe9ba75266c3d41a';
      wrap.innerHTML = `<div id="previewMap" class="footprint-map" style="height:400px;border-radius:8px;overflow:hidden;" data-provider="${provider}" data-amap-key="${key}" data-json="${url}"></div>`;
      
      // ç­‰å¾… DOM æ›´æ–°åæ‰‹åŠ¨åˆå§‹åŒ–åœ°å›¾
      setTimeout(() => {
        const newEl = document.getElementById('previewMap');
        if(newEl && window.FootprintMap && typeof window.FootprintMap.bootstrapMap === 'function'){
          window.FootprintMap.bootstrapMap(newEl);
        }
      }, 100);
    }
    // åˆå§‹å°è¯•é¢„è§ˆ
    if(locations.length > 0) {
      generateJson();
      renderPreviewMap();
    }

    // provider ä¸‹æ‹‰æ§åˆ¶ä¸æŒä¹…åŒ–
    (function initProviderSelect(){
      const sel = document.getElementById('providerSelect');
      if(!sel) return;
      // æ¢å¤ä¸Šæ¬¡é€‰æ‹©ï¼Œé»˜è®¤ä½¿ç”¨ mapboxï¼ˆå› ä¸ºç¼–è¾‘å™¨å†…å·²ç»æ³¨å…¥ MAPBOX_TOKEN ä¾¿äºæœ¬åœ°æµ‹è¯•ï¼‰
      const saved = lsGet('footprintmap_builder_provider','mapbox');
      sel.value = saved;
      sel.addEventListener('change', ()=>{
        lsSet('footprintmap_builder_provider', sel.value);
        // é‡æ–°æ¸²æŸ“é¢„è§ˆ
        renderPreviewMap();
      });
    })();

    // æ ·å¼ï¼šä¸º invalid ç±»æ·»åŠ é«˜äº®ï¼ˆæ’å…¥ style åŠ¨æ€ç¡®ä¿è¦†ç›–ï¼‰
    const styleEl = document.createElement('style');
    styleEl.textContent = '.invalid{border-color:#dc2626 !important; background:#fef2f2 !important;}' +
      '.dragging{opacity:0.5;}' +
      '@media(max-width:640px){' +
        '#map{height:280px !important;}' +
        '.footprint-map{height:320px !important;}' +
        '.location-item{font-size:12px; padding:10px 12px; padding-left:28px; padding-bottom:44px;}' +
        '.marker-color-palette{gap:6px;}' +
        '.tags-options{gap:5px;}' +
        '.controls{gap:6px;}' +
        'button{padding:8px 12px; font-size:13px;}' +
      '}';
    document.head.appendChild(styleEl);
    // åˆå§‹åŒ–åˆ†ç±»ä¸é¢œè‰²æ§ä»¶
    initMarkerColorPalette(); renderCategoryOptions();
  </script>
</body>
</html>