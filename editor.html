<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>足迹数据构建器 - XiaoTen FootprintMap</title>
  <link rel="stylesheet" href="static/css/footprintmap.css" />
  <link rel="stylesheet" href="static/css/editor.css" />
</head>
<body>
  <header>
    <h1>足迹数据构建器</h1>
    <p>可视化录入地点信息，生成符合 XiaoTen-FootprintMap 规范的 JSON 数据。</p>
    <div class="mt-12">
      <a href="index.html" class="back-link">← 返回演示页</a>
    </div>
  </header>
  <main>
    <section class="panel panel--large">
      <h2>📝 地点录入</h2>
      <form id="locationForm" autocomplete="off">
        <div id="formErrors"></div>
        <div class="group">
          <label>名称 *（必填）</label>
          <input type="text" id="name" required placeholder="如：北京" aria-required="true" />
        </div>
        <div class="group">
          <label>描述（可选）</label>
          <textarea id="description" placeholder="简要描述该地点"></textarea>
        </div>
        <div class="inline">
          <div class="group">
            <label>日期（可选，YYYY-MM-DD）</label>
            <input type="date" id="date" />
          </div>
          <div class="group">
            <label>坐标 *（经度,纬度；可点击地图拾取）</label>
            <input type="text" id="coordinates" required placeholder="116.4074,39.9042" aria-required="true" />
          </div>
        </div>
        <div class="group">
          <label>标记颜色（可选，未选则自动轮换）</label>
          <div id="markerColorPalette" class="marker-color-palette" role="radiogroup" aria-label="选择标记颜色"></div>
          <input type="hidden" id="markerColor" value="" />
        </div>
        <div class="group">
          <label>分类（多选，默认：常驻 / 旅行 / 游记）</label>
          <div id="categoryOptions" class="tags-options" aria-label="分类多选"></div>
          <div class="inline mt-6">
            <input type="text" id="newCategoryInput" placeholder="输入后回车或点击添加" />
            <button type="button" class="secondary" id="addCategoryBtn">添加分类</button>
          </div>
          <div class="small">点击标签切换选中，自定义分类可添加后再点亮。</div>
        </div>
        <div class="group">
          <label>图片 URL（输入后回车或点击添加）</label>
          <div class="inline">
            <input type="text" id="photoInput" placeholder="https://...jpg" />
            <button type="button" class="secondary" id="addPhotoBtn">添加图片</button>
          </div>
          <div class="photos-list" id="photosList"></div>
        </div>
        <div class="inline">
          <div class="group">
            <label>关联链接 URL</label>
            <input type="text" id="url" placeholder="https://你的博客文章" />
          </div>
          <div class="group">
            <label>链接文字</label>
            <input type="text" id="urlLabel" placeholder="阅读游记" />
          </div>
        </div>
        <div class="controls">
          <button type="submit" id="submitBtn">✚ 添加地点</button>
          <button type="button" class="secondary" id="resetFormBtn">清空表单</button>
          <button type="button" class="secondary" id="cancelEditBtn">取消编辑</button>
        </div>
        <p class="small">必填项：名称、坐标。其他字段可选但推荐填写描述/日期以丰富信息。</p>
      </form>
      <h2 class="mt-26">🗺️ 坐标拾取</h2>
      <div class="search-row">
        <input type="text" id="placeSearchInput" placeholder="搜索地点以定位拾取，如：杭州西湖" />
        <button type="button" class="secondary" id="placeSearchBtn">搜索</button>
      </div>
      <div id="map"></div>
      <p class="small">直接点击地图任意位置即可拾取坐标（支持全球）。搜索功能仅支持中国境内地点，国外地点请通过地图缩放平移后点击获取。</p>
    </section>

    <section class="panel">
      <h2>📍 已添加地点</h2>
      <div class="location-list" id="locationList"></div>
      <div class="controls">
        <button type="button" class="secondary" id="clearAllBtn">清空所有</button>
        <button type="button" class="danger" id="removeLastBtn">删除最后一个</button>
      </div>
      <div class="import-block">
        <label class="import-label">导入已有 JSON 文件</label>
        <input type="file" id="importFile" accept="application/json" />
        <div class="mt-6">
          <label class="label-inline">
            <input type="checkbox" id="importAutoSort" />
            <span class="small-text">导入后自动按日期排序</span>
          </label>
        </div>
        <p class="small">会尝试读取其中的 locations 并追加。</p>
      </div>
      <h2 class="mt-24">🧾 导出 JSON</h2>
      <div class="controls">
        <button type="button" id="generateBtn">生成 JSON</button>
        <button type="button" class="secondary" id="copyBtn">复制到剪贴板</button>
        <button type="button" class="secondary" id="downloadBtn">下载文件</button>
        <button type="button" class="secondary" id="toggleSortDateBtn" data-on="0">开启按日期排序</button>
      </div>
      <pre id="jsonOutput" aria-label="输出 JSON"></pre>
    </section>
  </main>
  
    <div class="container">
    <section class="panel panel--full">
      <div class="panel-header">
        <h2 class="no-margin">🔍 实时预览</h2>
        <div class="panel-actions">
            <button type="button" class="secondary" id="refreshPreviewBtn">🔄 刷新预览</button>
            <button type="button" class="secondary" id="toggleThemeBtn">🌓 主题</button>
          </div>
      </div>
      <div id="previewMapWrap">
        <div id="previewMap" class="footprint-map" data-amap-key="4727334ebc13608dbe9ba75266c3d41a"></div>
      </div>
      <p class="small">预览为正式 FootprintMap 组件（含聚类、筛选、主题切换等），导出的 JSON 可直接用于生产环境。添加/编辑地点后，点击"刷新预览"更新地图。</p>
    </section>
  </div>
  
  <footer>
    <div>Made with ❤️ XiaoTen-FootprintMap 数据构建器 · 本地保存草稿，不会上传。</div>
    <div class="footer-note">© <a href="https://www.xiaoten.com" target="_blank" rel="noopener noreferrer">XiaoTen</a></div>
  </footer>

  <script>
    window._AMapSecurityConfig = {
      securityJsCode: '16835a13e9518124d6e8db523f0cdaad'
    };
  </script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=4727334ebc13608dbe9ba75266c3d41a"></script>
  <script defer src="static/js/footprintmap.js"></script>
  <script src="static/js/theme.js"></script>
  <script src="static/js/utils.js"></script>
  <script src="static/js/editor-utils.js"></script>
  <script src="static/js/editor-render.js"></script>
  <script src="static/js/editor-form.js"></script>
  <script src="static/js/editor-state.js"></script>
  <script src="static/js/editor-preview.js"></script>
  <script src="static/js/editor-actions.js"></script>
  <script>
    // 现在由 `static/js/editor-state.js` 管理所有运行时 state（locations, photosTemp, editingIndex 等）。
    // 这里仅在 DOM 加载完成后把一些 UI 控件与 EditorState 的初始状态同步（如导入偏好）。
    document.addEventListener('DOMContentLoaded', ()=>{
      try{
        const importAutoSortEl = document.getElementById('importAutoSort');
        if(!importAutoSortEl) return;
        if(window.EditorState && typeof window.EditorState.getImportAutoSort === 'function'){
          importAutoSortEl.checked = !!window.EditorState.getImportAutoSort();
        } else if(window.EditorState && typeof window.EditorState.getState === 'function'){
          const s = window.EditorState.getState(); importAutoSortEl.checked = !!s.importAutoSort;
        } else {
          // 旧兼容：如果未加载 EditorState，尝试从 localStorage 恢复导入偏好
          try{ const v = lsGet && lsGet('footprintmap_builder_importAutoSort','false'); importAutoSortEl.checked = (v === 'true'); }catch(e){}
        }
      }catch(e){ /* ignore */ }
    });
  </script>
</body>
</html>